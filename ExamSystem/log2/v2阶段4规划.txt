### ç¬¬ä¸€æ­¥ï¼šæ‰©å±•Databaseç±»çš„èŠå¤©æ–¹æ³• â°é¢„è®¡æ—¶é—´ï¼š2å°æ—¶

**æ–‡ä»¶ä¿®æ”¹**ï¼š`src/core/database.h`ã€`src/core/database.cpp`

**æ–°å¢æ ¸å¿ƒåŠŸèƒ½æ¨¡å—**ï¼š

#### ç§èŠå…³ç³»ç®¡ç†ï¼ˆ4ä¸ªæ–¹æ³•ï¼‰
```cpp
// åˆ›å»ºæˆ–è·å–ç§èŠå…³ç³»ID
int getOrCreatePrivateChat(int user1Id, const QString &user1Type, 
                          int user2Id, const QString &user2Type);

// è·å–ç”¨æˆ·çš„æ‰€æœ‰ç§èŠå…³ç³»
QList<QVariantMap> getPrivateChats(int userId, const QString &userType);

// æ›´æ–°ç§èŠæœ€åæ¶ˆæ¯æ—¶é—´
bool updatePrivateChatLastMessage(int chatId);

// æ£€æŸ¥ç§èŠæƒé™ï¼ˆåŸºäºå¥½å‹å…³ç³»ï¼‰
bool canChat(int user1Id, const QString &user1Type, 
             int user2Id, const QString &user2Type);
```

#### æ¶ˆæ¯ç®¡ç†ï¼ˆ6ä¸ªæ–¹æ³•ï¼‰
```cpp
// å‘é€æ¶ˆæ¯
int sendMessage(int chatId, const QString &chatType, 
                int senderId, const QString &senderType, 
                const QString &content);

// è·å–èŠå¤©è®°å½•
QList<QVariantMap> getChatMessages(int chatId, const QString &chatType, 
                                   int limit = 50, int offset = 0);

// è·å–æœ€æ–°æ¶ˆæ¯
QVariantMap getLastMessage(int chatId, const QString &chatType);

// åˆ é™¤æ¶ˆæ¯
bool deleteMessage(int messageId);

// è·å–æœªè¯»æ¶ˆæ¯æ•°é‡
int getUnreadMessageCount(int userId, const QString &userType);

// æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
bool markMessagesAsRead(int chatId, int userId, const QString &userType);
```

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- åŸºäºå¥½å‹å…³ç³»çš„æƒé™éªŒè¯
- æ”¯æŒåˆ†é¡µçš„æ¶ˆæ¯åŠ è½½
- æ—¶é—´æ’åºçš„æ¶ˆæ¯æ˜¾ç¤º
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºèŠå¤©ç›¸å…³æ•°æ®æ¨¡å‹ç±» â°é¢„è®¡æ—¶é—´ï¼š1.5å°æ—¶

**æ–°å»ºæ–‡ä»¶**ï¼š
- `src/models/chatinfo.h/cpp` - ç§èŠä¿¡æ¯å®ä½“ç±»
- `src/models/messageinfo.h/cpp` - æ¶ˆæ¯ä¿¡æ¯å®ä½“ç±»

**ChatInfoç±»è®¾è®¡**ï¼š
```cpp
class ChatInfo {
private:
    int chatId;
    int friendId;
    QString friendType;
    QString friendName;
    QString friendDisplayInfo;
    QString lastMessage;
    QDateTime lastMessageTime;
    int unreadCount;

public:
    // æ„é€ å‡½æ•°å’Œå±æ€§è®¿é—®å™¨
    ChatInfo(int id, int fId, const QString &fType, const QString &fName);
    
    // æ˜¾ç¤ºæ ¼å¼åŒ–æ–¹æ³•
    QString getDisplayName() const;
    QString getLastMessagePreview() const;
    QString getTimeDisplay() const;
    QString getUnreadBadge() const;
    
    // æ¯”è¾ƒæ’åºæ–¹æ³•
    bool operator<(const ChatInfo &other) const; // æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åº
};
```

**MessageInfoç±»è®¾è®¡**ï¼š
```cpp
class MessageInfo {
public:
    enum MessageType { TEXT, SYSTEM };
    enum MessageStatus { SENDING, SENT, FAILED };

private:
    int messageId;
    int senderId;
    QString senderType;
    QString senderName;
    QString content;
    QDateTime sendTime;
    MessageType type;
    MessageStatus status;
    bool isFromMe;

public:
    // æ„é€ å‡½æ•°å’Œå±æ€§è®¿é—®å™¨
    MessageInfo(int id, int sId, const QString &sType, const QString &sName);
    
    // æ˜¾ç¤ºæ ¼å¼åŒ–æ–¹æ³•
    QString getTimeDisplay() const;
    QString getSenderDisplay() const;
    QString getContentHtml() const; // æ”¯æŒç®€å•HTMLæ ¼å¼
    
    // çŠ¶æ€åˆ¤æ–­æ–¹æ³•
    bool isSentByMe() const;
    bool isSystemMessage() const;
    Qt::Alignment getAlignment() const; // æ¶ˆæ¯å¯¹é½æ–¹å¼
};
```

### ç¬¬ä¸‰æ­¥ï¼šå¼€å‘èŠå¤©é¡µé¢ç»„ä»¶ â°é¢„è®¡æ—¶é—´ï¼š4å°æ—¶

**æ–°å»ºæ–‡ä»¶**ï¼š`src/ui/chat/chatpage.h/cpp`

**QQé£æ ¼ç•Œé¢è®¾è®¡**ï¼š
```
[å·¦ä¾§èŠå¤©åˆ—è¡¨ 30%]           [å³ä¾§èŠå¤©çª—å£ 70%]
â”Œâ”€ ğŸ’¬ ç§èŠåˆ—è¡¨ â”€â”€â”€â”€â”€â”€â”     â”Œâ”€ ä¸ å¼ ä¸‰ çš„èŠå¤© â”€â”€â”€â”€â”€â”€â”
â”œâ”€ [å¼ ä¸‰]  åˆšåˆš      â”‚     â”‚ [æ¶ˆæ¯è®°å½•åŒºåŸŸ]         â”‚
â”‚   ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ â”‚     â”‚ å¼ ä¸‰ 09:30             â”‚
â”œâ”€ [æè€å¸ˆ] 2åˆ†é’Ÿå‰   â”‚     â”‚ â”Œâ”€ ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ  â”‚
â”‚   ä½œä¸šè®°å¾—æäº¤      â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”œâ”€ [ç‹åŒå­¦] 1å°æ—¶å‰   â”‚     â”‚ æˆ‘ 09:31         â”Œâ”€â”€â”€ â”‚
â”‚   æ˜å¤©è€ƒè¯•åŠ æ²¹      â”‚     â”‚ â”Œâ”€ æœ€è¿‘å­¦ä¹ æŒºå¿™çš„   â”‚ â”‚
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜ â”‚
â”œâ”€ ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š      â”‚     â”‚ [æ¶ˆæ¯è¾“å…¥åŒºåŸŸ]         â”‚
â”‚   æ€»ä¼šè¯: 3ä¸ª       â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   æœªè¯»æ¶ˆæ¯: 2æ¡     â”‚     â”‚ â”‚ [åœ¨æ­¤è¾“å…¥æ¶ˆæ¯...]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜     â”‚ â””â”€ [è¡¨æƒ…] [å‘é€] â”€â”€â”˜
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶è®¾è®¡**ï¼š

#### 1. èŠå¤©åˆ—è¡¨ç»„ä»¶ï¼ˆChatListWidgetï¼‰
```cpp
class ChatListWidget : public QListWidget {
    Q_OBJECT
private:
    Database *m_database;
    int m_currentUserId;
    QString m_currentUserType;
    QTimer *m_refreshTimer;

public:
    ChatListWidget(Database *db, int userId, const QString &userType, QWidget *parent);
    void refreshChatList();
    
public slots:
    void onChatSelected(QListWidgetItem *item);
    void onNewMessageReceived(int chatId);
    
signals:
    void chatSelected(int chatId, int friendId, const QString &friendName);
    
private:
    void createChatItem(const ChatInfo &chat);
    void updateUnreadBadge(int chatId, int count);
};
```

#### 2. èŠå¤©çª—å£ç»„ä»¶ï¼ˆChatWindowWidgetï¼‰
```cpp
class ChatWindowWidget : public QWidget {
    Q_OBJECT
private:
    Database *m_database;
    int m_currentUserId;
    QString m_currentUserType;
    int m_currentChatId;
    int m_friendId;
    QString m_friendName;
    
    QScrollArea *m_messageArea;
    QWidget *m_messageContainer;
    QVBoxLayout *m_messageLayout;
    QTextEdit *m_inputEdit;
    QPushButton *m_sendButton;

public:
    ChatWindowWidget(Database *db, int userId, const QString &userType, QWidget *parent);
    void openChat(int chatId, int friendId, const QString &friendName);
    
public slots:
    void sendMessage();
    void refreshMessages();
    
signals:
    void messageSent(int chatId);
    
private:
    void loadMessages();
    void addMessageBubble(const MessageInfo &message);
    void scrollToBottom();
    bool validateInput();
};
```

#### 3. æ¶ˆæ¯æ°”æ³¡ç»„ä»¶ï¼ˆMessageBubbleWidgetï¼‰
```cpp
class MessageBubbleWidget : public QWidget {
    Q_OBJECT
private:
    MessageInfo m_message;
    bool m_isFromMe;

public:
    MessageBubbleWidget(const MessageInfo &message, QWidget *parent);
    
protected:
    void paintEvent(QPaintEvent *event) override;
    
private:
    void setupLayout();
    QColor getBubbleColor() const;
    Qt::Alignment getAlignment() const;
};
```

### ç¬¬å››æ­¥ï¼šé›†æˆåˆ°ä¸»ç•Œé¢ â°é¢„è®¡æ—¶é—´ï¼š1.5å°æ—¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/ui/main/studentmainwindow.h/cpp`
- `src/ui/main/teachermainwindow.h/cpp`

**å­¦ç”Ÿç«¯é›†æˆ**ï¼š
```cpp
// studentmainwindow.h æ·»åŠ 
#include "../../ui/chat/chatpage.h"
private:
    ChatPage *m_chatPage;

// studentmainwindow.cpp ä¿®æ”¹
void StudentMainWindow::createChatPage()
{
    if (!database) {
        showErrorPage("èŠå¤©åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨");
        return;
    }
    
    m_chatPage = new ChatPage(database, currentStudent.getId(), "å­¦ç”Ÿ", this);
    
    // è¿æ¥ä¿¡å·æ§½
    connect(m_chatPage, &ChatPage::messageSent, 
            this, &StudentMainWindow::onMessageSent);
    connect(m_chatPage, &ChatPage::chatOpened, 
            this, &StudentMainWindow::onChatOpened);
    
    contentStack->addWidget(m_chatPage);
    chatPage = m_chatPage; // ä¿æŒå…¼å®¹æ€§
}

// æ–°å¢ä¿¡å·æ§½å¤„ç†æ–¹æ³•
void StudentMainWindow::onMessageSent(int chatId);
void StudentMainWindow::onChatOpened(int friendId, const QString &friendName);
```

**æ•™å¸ˆç«¯é›†æˆ**ï¼š
```cpp
// é‡‡ç”¨ä¸å­¦ç”Ÿç«¯ç›¸åŒçš„é›†æˆæ¨¡å¼
// ä¼ é€’æ•™å¸ˆIDå’Œ"è€å¸ˆ"ç±»å‹å‚æ•°
// ä¿æŒæ•™å¸ˆç«¯çº¢è‰²ä¸»é¢˜é£æ ¼
```

### ç¬¬äº”æ­¥ï¼šè§£å†³æŠ€æœ¯é—®é¢˜å’Œä¼˜åŒ– â°é¢„è®¡æ—¶é—´ï¼š2å°æ—¶

**é¢„æœŸæŠ€æœ¯æŒ‘æˆ˜**ï¼š

#### 1. æ¶ˆæ¯å®æ—¶åˆ·æ–°æœºåˆ¶
```cpp
// æ–¹æ¡ˆï¼šå®šæ—¶åˆ·æ–° + æ‰‹åŠ¨åˆ·æ–°
QTimer *refreshTimer = new QTimer(this);
connect(refreshTimer, &QTimer::timeout, this, &ChatPage::checkNewMessages);
refreshTimer->start(30000); // 30ç§’æ£€æŸ¥ä¸€æ¬¡æ–°æ¶ˆæ¯
```

#### 2. å¥½å‹å…³ç³»æƒé™éªŒè¯
```cpp
// å‘é€æ¶ˆæ¯å‰éªŒè¯å¥½å‹å…³ç³»
bool ChatPage::canSendMessage(int friendId, const QString &friendType) {
    return m_database->areFriends(m_currentUserId, m_currentUserType, 
                                  friendId, friendType);
}
```

#### 3. æ¶ˆæ¯æ°”æ³¡æ ·å¼å’Œå¸ƒå±€
```cpp
// ä½¿ç”¨QStyleSheetå®ç°ç°ä»£åŒ–æ°”æ³¡æ ·å¼
QString messageStyle = QString(
    "QWidget {"
    "    background-color: %1;"
    "    border-radius: 12px;"
    "    padding: 8px 12px;"
    "    margin: 4px %2;"
    "}"
).arg(bubbleColor, marginDirection);
```

#### 4. æ€§èƒ½ä¼˜åŒ–
- **åˆ†é¡µåŠ è½½**ï¼šä¸€æ¬¡åŠ è½½50æ¡æ¶ˆæ¯ï¼Œæ”¯æŒå‘ä¸Šæ»šåŠ¨åŠ è½½æ›´å¤š
- **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶æ¸…ç†æ—§æ¶ˆæ¯ç»„ä»¶ï¼Œé¿å…å†…å­˜æ³„æ¼
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æ¶ˆæ¯æŸ¥è¯¢æ€§èƒ½

### ç¬¬å…­æ­¥ï¼šæ›´æ–°é¡¹ç›®é…ç½® â°é¢„è®¡æ—¶é—´ï¼š0.5å°æ—¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š`CMakeLists.txt`

**æ–°å¢ç¼–è¯‘æ–‡ä»¶**ï¼š
```cmake
# èŠå¤©åŠŸèƒ½æ¨¡å—
src/models/chatinfo.h
src/models/chatinfo.cpp
src/models/messageinfo.h
src/models/messageinfo.cpp
src/ui/chat/chatpage.h
src/ui/chat/chatpage.cpp
src/ui/chat/chatlistwidget.h
src/ui/chat/chatlistwidget.cpp
src/ui/chat/chatwindowwidget.h
src/ui/chat/chatwindowwidget.cpp
src/ui/chat/messagebubblewidget.h
src/ui/chat/messagebubblewidget.cpp
```




