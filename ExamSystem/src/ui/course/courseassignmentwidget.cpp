#include "courseassignmentwidget.h"
#include "../../models/course.h"
#include "../../models/courseassignment.h"
#include "../../models/assignmentsubmission.h"
#include <QMessageBox>
#include <QFormLayout>
#include <QCheckBox>
#include <QHeaderView>
#include <QApplication>
#include <QInputDialog>

CourseAssignmentWidget::CourseAssignmentWidget(Database *database, int userId, const QString &userType, QWidget *parent)
    : QWidget(parent)
    , m_database(database)
    , m_userId(userId)
    , m_userType(userType)
    , m_isTeacher(userType == "ËÄÅÂ∏à")
    , m_selectedAssignmentId(-1)
    , m_refreshTimer(new QTimer(this))
{
    setupUI();
    setupStyles();

    // ËÆæÁΩÆËá™Âä®Âà∑Êñ∞
    m_refreshTimer->setInterval(30000); // 30ÁßíËá™Âä®Âà∑Êñ∞
    connect(m_refreshTimer, &QTimer::timeout, this, &CourseAssignmentWidget::onAutoRefresh);
    m_refreshTimer->start();

    refreshData();
}

void CourseAssignmentWidget::setupUI()
{
    m_mainLayout = new QHBoxLayout(this);
    m_mainLayout->setContentsMargins(0, 0, 0, 0);

    // ÂàõÂª∫ÂàÜÂâ≤Âô®
    m_splitter = new QSplitter(Qt::Horizontal, this);
    m_mainLayout->addWidget(m_splitter);

    // Â∑¶‰æß‰Ωú‰∏öÂàóË°®Âå∫Âüü
    m_leftWidget = new QWidget();
    m_leftWidget->setFixedWidth(380); // Â¢ûÂä†ÂÆΩÂ∫¶‰ª•ÂÆπÁ∫≥Êõ¥Â§ö‰ø°ÊÅØ
    m_leftLayout = new QVBoxLayout(m_leftWidget);
    m_leftLayout->setContentsMargins(10, 10, 10, 10);

    // Á≠õÈÄâÂå∫ÂüüÔºàÂ¢ûÂº∫ÁâàÔºâ
    m_filterGroup = new QGroupBox("Á≠õÈÄâ‰∏éÊêúÁ¥¢");
    QVBoxLayout *filterLayout = new QVBoxLayout(m_filterGroup);

    m_courseFilterCombo = new QComboBox();
    m_statusFilterCombo = new QComboBox();
    m_statusFilterCombo->addItems({"ÂÖ®ÈÉ®Áä∂ÊÄÅ", "ÂºÄÊîæÊèê‰∫§", "Â∑≤Êà™Ê≠¢"});

    m_searchLineEdit = new QLineEdit();
    m_searchLineEdit->setPlaceholderText("ÊêúÁ¥¢‰Ωú‰∏öÊ†áÈ¢ò...");

    m_refreshButton = new QPushButton("üîÑ Âà∑Êñ∞");
    m_refreshButton->setToolTip("ÊâãÂä®Âà∑Êñ∞‰Ωú‰∏öÂàóË°®");

    filterLayout->addWidget(new QLabel("ËØæÁ®ã:"));
    filterLayout->addWidget(m_courseFilterCombo);
    filterLayout->addWidget(new QLabel("Áä∂ÊÄÅ:"));
    filterLayout->addWidget(m_statusFilterCombo);
    filterLayout->addWidget(new QLabel("ÊêúÁ¥¢:"));
    filterLayout->addWidget(m_searchLineEdit);
    filterLayout->addWidget(m_refreshButton);

    m_leftLayout->addWidget(m_filterGroup);

    // ÁªüËÆ°‰ø°ÊÅØÂå∫Âüü
    m_statsGroup = new QGroupBox("ÁªüËÆ°‰ø°ÊÅØ");
    QVBoxLayout *statsLayout = new QVBoxLayout(m_statsGroup);

    m_totalAssignmentsLabel = new QLabel("ÊÄª‰Ωú‰∏öÊï∞: 0");
    m_openAssignmentsLabel = new QLabel("ÂºÄÊîæ‰∏≠: 0");

    if (m_isTeacher) {
        m_gradedLabel = new QLabel("Â∑≤ÊâπÊîπ: 0");
        statsLayout->addWidget(m_totalAssignmentsLabel);
        statsLayout->addWidget(m_openAssignmentsLabel);
        statsLayout->addWidget(m_gradedLabel);
    } else {
        m_submittedLabel = new QLabel("Â∑≤Êèê‰∫§: 0");
        statsLayout->addWidget(m_totalAssignmentsLabel);
        statsLayout->addWidget(m_openAssignmentsLabel);
        statsLayout->addWidget(m_submittedLabel);
    }

    m_leftLayout->addWidget(m_statsGroup);

    // ‰Ωú‰∏öÂàóË°®
    m_listGroup = new QGroupBox("ËØæÁ®ã‰Ωú‰∏ö");
    QVBoxLayout *listLayout = new QVBoxLayout(m_listGroup);

    m_assignmentList = new QListWidget();
    m_assignmentList->setAlternatingRowColors(true);
    listLayout->addWidget(m_assignmentList);

    m_assignmentCountLabel = new QLabel("ÂÖ±0‰∏™‰Ωú‰∏ö");
    listLayout->addWidget(m_assignmentCountLabel);

    m_leftLayout->addWidget(m_listGroup);

    // Êìç‰ΩúÊåâÈíÆ
    if (m_isTeacher) {
        setupTeacherUI();
    } else {
        setupStudentUI();
    }

    m_splitter->addWidget(m_leftWidget);

    // Âè≥‰æß‰Ωú‰∏öËØ¶ÊÉÖÂå∫Âüü
    m_assignmentDetailWidget = new AssignmentDetailWidget(this);
    m_assignmentDetailWidget->m_database = m_database; // ‰º†ÈÄíÊï∞ÊçÆÂ∫ìËøûÊé•

    // Â¶ÇÊûúÊòØÂ≠¶ÁîüÁ´ØÔºåËÆæÁΩÆÂ≠¶ÁîüID
    if (!m_isTeacher) {
        m_assignmentDetailWidget->setStudentId(m_userId);
    }

    m_splitter->addWidget(m_assignmentDetailWidget);

    // ËÆæÁΩÆÂàÜÂâ≤Âô®ÊØî‰æã
    m_splitter->setSizes({380, 700});

    // ËøûÊé•‰ø°Âè∑ÊßΩ
    connect(m_assignmentList, &QListWidget::itemClicked, this, &CourseAssignmentWidget::onAssignmentSelected);
    connect(m_refreshButton, &QPushButton::clicked, this, &CourseAssignmentWidget::onRefreshClicked);
    connect(m_courseFilterCombo, QOverload<int>::of(&QComboBox::currentIndexChanged),
            this, &CourseAssignmentWidget::onCourseFilterChanged);
    connect(m_statusFilterCombo, QOverload<int>::of(&QComboBox::currentIndexChanged),
            this, &CourseAssignmentWidget::onStatusFilterChanged);
    connect(m_searchLineEdit, &QLineEdit::textChanged, this, &CourseAssignmentWidget::onSearchTextChanged);
}

void CourseAssignmentWidget::setupTeacherUI()
{
    m_actionGroup = new QGroupBox("Êìç‰Ωú");
    QVBoxLayout *actionLayout = new QVBoxLayout(m_actionGroup);

    m_publishButton = new QPushButton("üìù ÂèëÂ∏É‰Ωú‰∏ö");
    m_editButton = new QPushButton("‚úèÔ∏è ÁºñËæë‰Ωú‰∏ö");
    m_gradeButton = new QPushButton("üìä ÊâπÊîπ‰Ωú‰∏ö");
    m_deleteButton = new QPushButton("üóëÔ∏è Âà†Èô§‰Ωú‰∏ö");

    // ÂàùÂßãÁä∂ÊÄÅÔºöÂè™ÊúâÂèëÂ∏ÉÊåâÈíÆÂèØÁî®
    m_editButton->setEnabled(false);
    m_gradeButton->setEnabled(false);
    m_deleteButton->setEnabled(false);

    // ËÆæÁΩÆÊåâÈíÆÊ†∑Âºè
    m_publishButton->setObjectName("publishButton");
    m_editButton->setObjectName("editButton");
    m_gradeButton->setObjectName("gradeButton");
    m_deleteButton->setObjectName("deleteButton");

    actionLayout->addWidget(m_publishButton);
    actionLayout->addWidget(m_editButton);
    actionLayout->addWidget(m_gradeButton);
    actionLayout->addWidget(m_deleteButton);

    m_leftLayout->addWidget(m_actionGroup);

    connect(m_publishButton, &QPushButton::clicked, this, &CourseAssignmentWidget::onPublishAssignment);
    connect(m_editButton, &QPushButton::clicked, this, &CourseAssignmentWidget::onEditAssignment);
    connect(m_gradeButton, &QPushButton::clicked, this, &CourseAssignmentWidget::onGradeAssignment);
    connect(m_deleteButton, &QPushButton::clicked, this, &CourseAssignmentWidget::onDeleteAssignment);
}

void CourseAssignmentWidget::setupStudentUI()
{
    m_actionGroup = new QGroupBox("Êìç‰Ωú");
    QVBoxLayout *actionLayout = new QVBoxLayout(m_actionGroup);

    m_submitButton = new QPushButton("üì§ Êèê‰∫§‰Ωú‰∏ö");
    m_submitButton->setEnabled(false);
    m_submitButton->setObjectName("submitButton");

    actionLayout->addWidget(m_submitButton);

    m_leftLayout->addWidget(m_actionGroup);

    connect(m_submitButton, &QPushButton::clicked, this, &CourseAssignmentWidget::onSubmitAssignment);
}

void CourseAssignmentWidget::setupStyles()
{
    this->setStyleSheet(
        "QGroupBox {"
        "    font-weight: bold;"
        "    border: 1px solid #ddd;"
        "    border-radius: 8px;"
        "    margin-top: 8px;"
        "    padding-top: 12px;"
        "    background-color: #fafafa;"
        "}"
        "QGroupBox::title {"
        "    subcontrol-origin: margin;"
        "    left: 10px;"
        "    padding: 0 8px 0 8px;"
        "    color: #2c3e50;"
        "    font-size: 13px;"
        "}"
        "QListWidget {"
        "    border: 1px solid #ddd;"
        "    border-radius: 6px;"
        "    background-color: white;"
        "    alternate-background-color: #f8f9fa;"
        "}"
        "QListWidget::item {"
        "    padding: 15px;"
        "    border-bottom: 1px solid #eee;"
        "    margin: 1px;"
        "    border-radius: 4px;"
        "    min-height: 60px;"
        "}"
        "QListWidget::item:selected {"
        "    background-color: #e6f7ff;"
        "    border: 2px solid #1890ff;"
        "}"
        "QListWidget::item:hover {"
        "    background-color: #f0f8ff;"
        "}"

        // ÊåâÈíÆÊ†∑Âºè
        "#publishButton {"
        "    background-color: #52c41a;"
        "    border: none;"
        "    border-radius: 6px;"
        "    color: white;"
        "    font-size: 14px;"
        "    font-weight: bold;"
        "    padding: 10px 16px;"
        "}"
        "#publishButton:hover {"
        "    background-color: #389e0d;"
        "}"
        "#editButton {"
        "    background-color: #1890ff;"
        "    border: none;"
        "    border-radius: 6px;"
        "    color: white;"
        "    font-size: 14px;"
        "    padding: 10px 16px;"
        "}"
        "#editButton:hover {"
        "    background-color: #096dd9;"
        "}"
        "#gradeButton {"
        "    background-color: #fa8c16;"
        "    border: none;"
        "    border-radius: 6px;"
        "    color: white;"
        "    font-size: 14px;"
        "    padding: 10px 16px;"
        "}"
        "#gradeButton:hover {"
        "    background-color: #d46b08;"
        "}"
        "#deleteButton {"
        "    background-color: #ff4d4f;"
        "    border: none;"
        "    border-radius: 6px;"
        "    color: white;"
        "    font-size: 14px;"
        "    padding: 10px 16px;"
        "}"
        "#deleteButton:hover {"
        "    background-color: #cf1322;"
        "}"
        "#submitButton {"
        "    background-color: #1890ff;"
        "    border: none;"
        "    border-radius: 6px;"
        "    color: white;"
        "    font-size: 14px;"
        "    font-weight: bold;"
        "    padding: 12px 20px;"
        "}"
        "#submitButton:hover {"
        "    background-color: #096dd9;"
        "}"

        "QPushButton:disabled {"
        "    background-color: #f5f5f5;"
        "    color: #999;"
        "    border: 1px solid #d9d9d9;"
        "}"

        "QLineEdit {"
        "    border: 1px solid #ddd;"
        "    border-radius: 4px;"
        "    padding: 8px;"
        "    font-size: 14px;"
        "}"
        "QLineEdit:focus {"
        "    border-color: #1890ff;"
        "}"

        "QComboBox {"
        "    border: 1px solid #ddd;"
        "    border-radius: 4px;"
        "    padding: 8px;"
        "    font-size: 14px;"
        "}"
        );
}

void CourseAssignmentWidget::refreshData()
{
    try {
        updateCourseFilter();
        updateAssignmentList();
        updateStatistics();
        updateButtonStates();

        qDebug() << "ËØæÁ®ã‰Ωú‰∏öÊï∞ÊçÆÂà∑Êñ∞ÂÆåÊàê";
    } catch (const std::exception &e) {
        qDebug() << "Âà∑Êñ∞Êï∞ÊçÆÊó∂ÂèëÁîüÂºÇÂ∏∏:" << e.what();
        showMessage("Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï", true);
    } catch (...) {
        qDebug() << "Âà∑Êñ∞Êï∞ÊçÆÊó∂ÂèëÁîüÊú™Áü•ÂºÇÂ∏∏";
        showMessage("Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï", true);
    }
}

void CourseAssignmentWidget::updateCourseFilter()
{
    if (!m_database) {
        qDebug() << "Êï∞ÊçÆÂ∫ìËøûÊé•Êó†Êïà";
        return;
    }

    try {
        m_courseFilterCombo->clear();
        m_courseFilterCombo->addItem("ÂÖ®ÈÉ®ËØæÁ®ã");

        if (m_isTeacher) {
            QList<Course> courses = m_database->getTeacherCourses(m_userId);
            m_teacherCourses.clear();

            for (const Course &course : courses) {
                QVariantMap courseMap;
                courseMap["course_id"] = course.getCourseId();
                courseMap["course_name"] = course.getCourseName();
                m_teacherCourses.append(courseMap);

                m_courseFilterCombo->addItem(course.getCourseName(), course.getCourseId());
            }
        } else {
            m_studentCourses = m_database->getStudentCourses(m_userId);

            for (const QVariantMap &course : m_studentCourses) {
                if (course["enrollment_status"].toString() == "Â∑≤ÈÄöËøá") {
                    QString courseName = course["course_name"].toString();
                    int courseId = course["course_id"].toInt();
                    m_courseFilterCombo->addItem(courseName, courseId);
                }
            }
        }
    } catch (...) {
        qDebug() << "Êõ¥Êñ∞ËØæÁ®ãÁ≠õÈÄâÂô®Êó∂ÂèëÁîüÂºÇÂ∏∏";
    }
}

void CourseAssignmentWidget::updateAssignmentList()
{
    if (!m_database) return;

    try {
        m_assignments.clear();
        m_assignmentList->clear();

        QList<QVariantMap> filteredAssignments = getFilteredAssignments();

        for (const QVariantMap &assignment : filteredAssignments) {
            createAssignmentListItem(assignment);
            m_assignments.append(assignment);
        }

        m_assignmentCountLabel->setText(QString("ÂÖ±%1‰∏™‰Ωú‰∏ö").arg(m_assignments.size()));

        // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
        m_selectedAssignmentId = -1;
        updateButtonStates();
        m_assignmentDetailWidget->clearContent();

    } catch (...) {
        qDebug() << "Êõ¥Êñ∞‰Ωú‰∏öÂàóË°®Êó∂ÂèëÁîüÂºÇÂ∏∏";
        showMessage("Âä†ËΩΩ‰Ωú‰∏öÂàóË°®Â§±Ë¥•", true);
    }
}

void CourseAssignmentWidget::updateStatistics()
{
    if (!m_database || m_assignments.isEmpty()) {
        m_totalAssignmentsLabel->setText("ÊÄª‰Ωú‰∏öÊï∞: 0");
        m_openAssignmentsLabel->setText("ÂºÄÊîæ‰∏≠: 0");
        if (m_isTeacher) {
            if (m_gradedLabel) m_gradedLabel->setText("Â∑≤ÊâπÊîπ: 0");
        } else {
            if (m_submittedLabel) m_submittedLabel->setText("Â∑≤Êèê‰∫§: 0");
        }
        return;
    }

    try {
        int totalCount = m_assignments.size();
        int openCount = 0;
        int submittedOrGradedCount = 0;

        for (const QVariantMap &assignment : m_assignments) {
            if (assignment["status"].toString() == "ÂºÄÊîæÊèê‰∫§") {
                openCount++;
            }

            if (m_isTeacher) {
                // ÊïôÂ∏àÁ´ØÁªüËÆ°Â∑≤ÊâπÊîπÁöÑ‰Ωú‰∏öÊï∞
                // ËøôÈáåÂèØ‰ª•Êâ©Â±ï‰∏∫ÁúüÊ≠£ÁöÑÊâπÊîπÁªüËÆ°
            } else {
                // Â≠¶ÁîüÁ´ØÁªüËÆ°Â∑≤Êèê‰∫§ÁöÑ‰Ωú‰∏öÊï∞
                if (assignment["has_submitted"].toBool()) {
                    submittedOrGradedCount++;
                }
            }
        }

        m_totalAssignmentsLabel->setText(QString("ÊÄª‰Ωú‰∏öÊï∞: %1").arg(totalCount));
        m_openAssignmentsLabel->setText(QString("ÂºÄÊîæ‰∏≠: %1").arg(openCount));

        if (m_isTeacher) {
            if (m_gradedLabel) m_gradedLabel->setText(QString("ÂæÖÊâπÊîπ: %1").arg(totalCount - submittedOrGradedCount));
        } else {
            if (m_submittedLabel) m_submittedLabel->setText(QString("Â∑≤Êèê‰∫§: %1").arg(submittedOrGradedCount));
        }
    } catch (...) {
        qDebug() << "Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØÊó∂ÂèëÁîüÂºÇÂ∏∏";
    }
}

void CourseAssignmentWidget::updateButtonStates()
{
    bool hasSelection = (m_selectedAssignmentId > 0);

    if (m_isTeacher) {
        m_editButton->setEnabled(hasSelection);
        m_gradeButton->setEnabled(hasSelection);
        m_deleteButton->setEnabled(hasSelection);
    } else {
        // Â≠¶ÁîüÁ´ØÔºöÊ£ÄÊü•ÊòØÂê¶ÂèØ‰ª•Êèê‰∫§
        bool canSubmit = false;
        if (hasSelection) {
            for (const QVariantMap &assignment : m_assignments) {
                if (assignment["assignment_id"].toInt() == m_selectedAssignmentId) {
                    QString status = assignment["status"].toString();
                    bool hasSubmitted = assignment["has_submitted"].toBool();
                    QDateTime deadline = assignment["deadline"].toDateTime();
                    canSubmit = (status == "ÂºÄÊîæÊèê‰∫§" && !hasSubmitted && QDateTime::currentDateTime() < deadline);
                    break;
                }
            }
        }
        m_submitButton->setEnabled(canSubmit);
    }
}

QList<QVariantMap> CourseAssignmentWidget::getFilteredAssignments()
{
    QList<QVariantMap> allAssignments;

    if (!m_database) return allAssignments;

    try {
        int selectedCourseId = m_courseFilterCombo->currentData().toInt();
        QString statusFilter = m_statusFilterCombo->currentText();
        QString searchText = m_searchLineEdit->text().trimmed().toLower();

        if (m_isTeacher) {
            // ÊïôÂ∏àÁ´ØÔºöËé∑ÂèñËá™Â∑±ËØæÁ®ãÁöÑ‰Ωú‰∏ö
            for (const QVariantMap &course : m_teacherCourses) {
                int courseId = course["course_id"].toInt();

                if (selectedCourseId > 0 && courseId != selectedCourseId) {
                    continue;
                }

                QList<QVariantMap> courseAssignments = m_database->getCourseAssignments(courseId);
                for (QVariantMap assignment : courseAssignments) {
                    assignment["course_name"] = course["course_name"].toString();
                    allAssignments.append(assignment);
                }
            }
        } else {
            // Â≠¶ÁîüÁ´ØÔºöËé∑ÂèñÂ∑≤ÈÄâËØæÁ®ãÁöÑ‰Ωú‰∏ö
            allAssignments = m_database->getStudentAssignments(m_userId);
        }

        // Â∫îÁî®Áä∂ÊÄÅËøáÊª§
        if (statusFilter != "ÂÖ®ÈÉ®Áä∂ÊÄÅ") {
            QList<QVariantMap> filteredAssignments;
            for (const QVariantMap &assignment : allAssignments) {
                QString status = assignment["status"].toString();
                if (statusFilter == status) {
                    filteredAssignments.append(assignment);
                }
            }
            allAssignments = filteredAssignments;
        }

        // Â∫îÁî®ÊêúÁ¥¢ËøáÊª§
        if (!searchText.isEmpty()) {
            QList<QVariantMap> searchedAssignments;
            for (const QVariantMap &assignment : allAssignments) {
                QString title = assignment["title"].toString().toLower();
                QString courseName = assignment["course_name"].toString().toLower();
                if (title.contains(searchText) || courseName.contains(searchText)) {
                    searchedAssignments.append(assignment);
                }
            }
            allAssignments = searchedAssignments;
        }
    } catch (...) {
        qDebug() << "Á≠õÈÄâ‰Ωú‰∏öÊó∂ÂèëÁîüÂºÇÂ∏∏";
    }

    return allAssignments;
}

void CourseAssignmentWidget::createAssignmentListItem(const QVariantMap &assignment)
{
    try {
        QListWidgetItem *item = new QListWidgetItem();

        QString title = assignment["title"].toString();
        QString courseName = assignment["course_name"].toString();
        QDateTime deadline = assignment["deadline"].toDateTime();
        QString status = assignment["status"].toString();
        int assignmentId = assignment["assignment_id"].toInt();
        int maxScore = assignment["max_score"].toInt();

        // ËÆ°ÁÆóÂâ©‰ΩôÊó∂Èó¥
        QString timeText;
        QDateTime now = QDateTime::currentDateTime();
        qint64 secsToDeadline = now.secsTo(deadline);

        if (secsToDeadline < 0) {
            timeText = "Â∑≤ËøáÊúü";
        } else if (secsToDeadline < 3600) {
            timeText = QString("Ââ©‰Ωô%1ÂàÜÈíü").arg(secsToDeadline / 60);
        } else if (secsToDeadline < 86400) {
            timeText = QString("Ââ©‰Ωô%1Â∞èÊó∂").arg(secsToDeadline / 3600);
        } else {
            timeText = QString("Ââ©‰Ωô%1Â§©").arg(secsToDeadline / 86400);
        }

        QString displayText;
        if (m_isTeacher) {
            // ÊïôÂ∏àÁ´ØÊòæÁ§∫
            displayText = QString("üìã %1\nüìö ËØæÁ®ã: %2\n‚è∞ %3 | üìä Êª°ÂàÜ: %4ÂàÜ\nüìà Áä∂ÊÄÅ: %5")
                              .arg(title)
                              .arg(courseName)
                              .arg(deadline.toString("MM-dd hh:mmÊà™Ê≠¢"))
                              .arg(maxScore)
                              .arg(status);
        } else {
            // Â≠¶ÁîüÁ´ØÊòæÁ§∫Êèê‰∫§Áä∂ÊÄÅ
            bool hasSubmitted = assignment["has_submitted"].toBool();
            QString submissionStatus = hasSubmitted ? "‚úÖ Â∑≤Êèê‰∫§" : "‚ùå Êú™Êèê‰∫§";

            displayText = QString("üìã %1\nüìö ËØæÁ®ã: %2\n‚è∞ %3 |  Êª°ÂàÜ: %4ÂàÜ\n %5 |  %6")
                              .arg(title)
                              .arg(courseName)
                              .arg(timeText)
                              .arg(maxScore)
                              .arg(submissionStatus)
                              .arg(status);
        }

        item->setText(displayText);
        item->setData(Qt::UserRole, assignmentId);

        // Ê†πÊçÆÁä∂ÊÄÅËÆæÁΩÆÈ¢úËâ≤
        if (status == "Â∑≤Êà™Ê≠¢" || secsToDeadline < 0) {
            item->setBackground(QBrush(QColor(255, 245, 245))); // ÊµÖÁ∫¢Ëâ≤
        } else if (!m_isTeacher && assignment["has_submitted"].toBool()) {
            item->setBackground(QBrush(QColor(245, 255, 245))); // ÊµÖÁªøËâ≤
        } else if (secsToDeadline < 86400 && secsToDeadline > 0) {
            item->setBackground(QBrush(QColor(255, 250, 205))); // ÊµÖÈªÑËâ≤ÔºàÂç≥Â∞ÜÊà™Ê≠¢Ôºâ
        }

        m_assignmentList->addItem(item);

    } catch (...) {
        qDebug() << "ÂàõÂª∫‰Ωú‰∏öÂàóË°®È°πÊó∂ÂèëÁîüÂºÇÂ∏∏";
    }
}

void CourseAssignmentWidget::onAssignmentSelected(QListWidgetItem *item)
{
    if (!item) return;

    try {
        int assignmentId = item->data(Qt::UserRole).toInt();
        m_selectedAssignmentId = assignmentId;

        // ÊâæÂà∞ÂØπÂ∫îÁöÑ‰Ωú‰∏öÊï∞ÊçÆ
        QVariantMap selectedAssignment;
        for (const QVariantMap &assignment : m_assignments) {
            if (assignment["assignment_id"].toInt() == assignmentId) {
                selectedAssignment = assignment;
                break;
            }
        }

        if (!selectedAssignment.isEmpty()) {
            showAssignmentDetail(selectedAssignment);
            updateButtonStates();
        }
    } catch (...) {
        qDebug() << "ÈÄâÊã©‰Ωú‰∏öÊó∂ÂèëÁîüÂºÇÂ∏∏";
    }
}

void CourseAssignmentWidget::showAssignmentDetail(const QVariantMap &assignment)
{
    try {
        m_assignmentDetailWidget->showAssignment(assignment, m_isTeacher);
    } catch (...) {
        qDebug() << "ÊòæÁ§∫‰Ωú‰∏öËØ¶ÊÉÖÊó∂ÂèëÁîüÂºÇÂ∏∏";
    }
}

void CourseAssignmentWidget::onPublishAssignment()
{
    try {
        PublishAssignmentDialog dialog(m_database, m_userId, this);
        connect(&dialog, &QDialog::accepted, [this]() {
            refreshData();
            emit assignmentPublished(0);
        });

        dialog.exec();
    } catch (...) {
        qDebug() << "ÂèëÂ∏É‰Ωú‰∏öÊó∂ÂèëÁîüÂºÇÂ∏∏";
        showMessage("ÂèëÂ∏É‰Ωú‰∏öÂ§±Ë¥•", true);
    }
}

void CourseAssignmentWidget::onEditAssignment()
{
    if (m_selectedAssignmentId <= 0) {
        showMessage("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁºñËæëÁöÑ‰Ωú‰∏ö", true);
        return;
    }

    showMessage("ÁºñËæë‰Ωú‰∏öÂäüËÉΩÂºÄÂèë‰∏≠...", false);
    // TODO: ÂÆûÁé∞ÁºñËæë‰Ωú‰∏öÂäüËÉΩ
}

void CourseAssignmentWidget::onDeleteAssignment()
{
    if (m_selectedAssignmentId <= 0) {
        showMessage("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑ‰Ωú‰∏ö", true);
        return;
    }

    QMessageBox::StandardButton reply = QMessageBox::question(
        this, "Á°ÆËÆ§Âà†Èô§",
        "Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰Ωú‰∏öÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ",
        QMessageBox::Yes | QMessageBox::No);

    if (reply == QMessageBox::Yes) {
        try {
            if (m_database->deleteAssignment(m_selectedAssignmentId)) {
                showMessage("‰Ωú‰∏öÂà†Èô§ÊàêÂäü", false);
                refreshData();
            } else {
                showMessage("‰Ωú‰∏öÂà†Èô§Â§±Ë¥•", true);
            }
        } catch (...) {
            qDebug() << "Âà†Èô§‰Ωú‰∏öÊó∂ÂèëÁîüÂºÇÂ∏∏";
            showMessage("Âà†Èô§‰Ωú‰∏öÂ§±Ë¥•", true);
        }
    }
}

void CourseAssignmentWidget::onSubmitAssignment()
{
    if (m_selectedAssignmentId <= 0) {
        showMessage("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊèê‰∫§ÁöÑ‰Ωú‰∏ö", true);
        return;
    }

    try {
        // ÊâæÂà∞ÈÄâ‰∏≠ÁöÑ‰Ωú‰∏ö
        QVariantMap selectedAssignment;
        for (const QVariantMap &assignment : m_assignments) {
            if (assignment["assignment_id"].toInt() == m_selectedAssignmentId) {
                selectedAssignment = assignment;
                break;
            }
        }

        if (selectedAssignment.isEmpty()) {
            showMessage("Êâæ‰∏çÂà∞ÈÄâ‰∏≠ÁöÑ‰Ωú‰∏ö", true);
            return;
        }

        QString title = selectedAssignment["title"].toString();
        SubmitAssignmentDialog dialog(m_selectedAssignmentId, title, m_database, m_userId, this);
        connect(&dialog, &QDialog::accepted, [this]() {
            refreshData();
            emit assignmentSubmitted(m_selectedAssignmentId);
        });

        dialog.exec();

    } catch (...) {
        qDebug() << "Êèê‰∫§‰Ωú‰∏öÊó∂ÂèëÁîüÂºÇÂ∏∏";
        showMessage("Êèê‰∫§‰Ωú‰∏öÂ§±Ë¥•", true);
    }
}

void CourseAssignmentWidget::onGradeAssignment()
{
    if (m_selectedAssignmentId <= 0) {
        showMessage("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊâπÊîπÁöÑ‰Ωú‰∏ö", true);
        return;
    }

    try {
        // ÂàõÂª∫ÊâπÊîπ‰Ωú‰∏öÂØπËØùÊ°Ü
        GradeAssignmentDialog *dialog = new GradeAssignmentDialog(m_database, m_selectedAssignmentId, this);
        dialog->setAttribute(Qt::WA_DeleteOnClose);

        connect(dialog, &QDialog::accepted, [this]() {
            refreshData();
            emit assignmentGraded(m_selectedAssignmentId);
        });

        dialog->show();

    } catch (...) {
        qDebug() << "ÊâìÂºÄÊâπÊîπÁïåÈù¢Êó∂ÂèëÁîüÂºÇÂ∏∏";
        showMessage("ÊâìÂºÄÊâπÊîπÁïåÈù¢Â§±Ë¥•", true);
    }
}

void CourseAssignmentWidget::onRefreshClicked()
{
    refreshData();
}

void CourseAssignmentWidget::onAutoRefresh()
{
    // Ëá™Âä®Âà∑Êñ∞Êó∂‰∏çÊòæÁ§∫ÊèêÁ§∫
    try {
        updateAssignmentList();
        updateStatistics();
    } catch (...) {
        qDebug() << "Ëá™Âä®Âà∑Êñ∞Â§±Ë¥•";
    }
}

void CourseAssignmentWidget::onCourseFilterChanged()
{
    updateAssignmentList();
    updateStatistics();
}

void CourseAssignmentWidget::onStatusFilterChanged()
{
    updateAssignmentList();
    updateStatistics();
}

void CourseAssignmentWidget::onSearchTextChanged()
{
    // Âª∂ËøüÊêúÁ¥¢ÔºåÈÅøÂÖçÈ¢ëÁπÅÊü•ËØ¢
    static QTimer *searchTimer = nullptr;
    if (!searchTimer) {
        searchTimer = new QTimer(this);
        searchTimer->setSingleShot(true);
        searchTimer->setInterval(500); // 500msÂª∂Ëøü
        connect(searchTimer, &QTimer::timeout, [this]() {
            updateAssignmentList();
            updateStatistics();
        });
    }

    searchTimer->start();
}

void CourseAssignmentWidget::showMessage(const QString &message, bool isError)
{
    if (isError) {
        QMessageBox::warning(this, "ÊèêÁ§∫", message);
    } else {
        QMessageBox::information(this, "ÊèêÁ§∫", message);
    }
}

// ============================================================================
// AssignmentDetailWidget - ‰Ωú‰∏öËØ¶ÊÉÖÁªÑ‰ª∂ÂÆûÁé∞ÔºàÂ¢ûÂº∫ÁâàÔºâ
// ============================================================================

AssignmentDetailWidget::AssignmentDetailWidget(QWidget *parent)
    : QWidget(parent), m_database(nullptr), m_isTeacherMode(false), m_currentStudentId(-1)
{
    setupUI();
    setupStyles();
    clearContent();
}

void AssignmentDetailWidget::setupUI()
{
    m_mainLayout = new QVBoxLayout(this);
    m_mainLayout->setContentsMargins(20, 20, 20, 20);

    // ÂàõÂª∫ÊªöÂä®Âå∫Âüü
    m_scrollArea = new QScrollArea();
    m_scrollArea->setWidgetResizable(true);
    m_scrollArea->setHorizontalScrollBarPolicy(Qt::ScrollBarAsNeeded);
    m_scrollArea->setVerticalScrollBarPolicy(Qt::ScrollBarAsNeeded);

    m_contentWidget = new QWidget();
    QVBoxLayout *contentLayout = new QVBoxLayout(m_contentWidget);

    // Âü∫Êú¨‰ø°ÊÅØ
    m_titleLabel = new QLabel();
    m_titleLabel->setObjectName("titleLabel");
    m_titleLabel->setWordWrap(true);

    m_infoLabel = new QLabel();
    m_infoLabel->setObjectName("infoLabel");

    contentLayout->addWidget(m_titleLabel);
    contentLayout->addWidget(m_infoLabel);

    // ‰Ωú‰∏öÊèèËø∞
    QLabel *descLabel = new QLabel("üìã ‰Ωú‰∏öÊèèËø∞:");
    descLabel->setObjectName("sectionLabel");
    m_descriptionEdit = new QTextEdit();
    m_descriptionEdit->setReadOnly(true);
    m_descriptionEdit->setMaximumHeight(150);

    contentLayout->addWidget(descLabel);
    contentLayout->addWidget(m_descriptionEdit);

    // Êèê‰∫§Áõ∏ÂÖ≥ÔºàÂ≠¶ÁîüÁ´ØÔºâ
    m_submissionGroup = new QGroupBox("üì§ ÊàëÁöÑÊèê‰∫§");
    QVBoxLayout *submissionLayout = new QVBoxLayout(m_submissionGroup);

    m_submissionEdit = new QTextEdit();
    m_submissionEdit->setReadOnly(true);
    m_submissionEdit->setMaximumHeight(120);

    m_gradeLabel = new QLabel();
    m_gradeLabel->setObjectName("gradeLabel");

    submissionLayout->addWidget(m_submissionEdit);
    submissionLayout->addWidget(m_gradeLabel);

    contentLayout->addWidget(m_submissionGroup);

    // ÁªüËÆ°Áõ∏ÂÖ≥ÔºàÊïôÂ∏àÁ´ØÔºâ
    m_statsGroup = new QGroupBox("üìä Êèê‰∫§ÁªüËÆ°");
    QVBoxLayout *statsLayout = new QVBoxLayout(m_statsGroup);

    m_submissionStatsLabel = new QLabel();
    m_gradeProgressBar = new QProgressBar();
    m_viewSubmissionsButton = new QPushButton("üë• Êü•ÁúãÊâÄÊúâÊèê‰∫§");

    statsLayout->addWidget(m_submissionStatsLabel);
    statsLayout->addWidget(m_gradeProgressBar);
    statsLayout->addWidget(m_viewSubmissionsButton);

    contentLayout->addWidget(m_statsGroup);

    // Ê¨¢ËøéÈ°µÈù¢
    m_welcomeWidget = new QWidget();
    QVBoxLayout *welcomeLayout = new QVBoxLayout(m_welcomeWidget);
    welcomeLayout->setAlignment(Qt::AlignCenter);
    m_welcomeLabel = new QLabel("üìù\n\nÈÄâÊã©Â∑¶‰æß‰Ωú‰∏öÊü•ÁúãËØ¶ÁªÜÂÜÖÂÆπ");
    m_welcomeLabel->setAlignment(Qt::AlignCenter);
    m_welcomeLabel->setObjectName("welcomeLabel");
    welcomeLayout->addWidget(m_welcomeLabel);

    contentLayout->addWidget(m_welcomeWidget);
    contentLayout->addStretch();

    m_scrollArea->setWidget(m_contentWidget);
    m_mainLayout->addWidget(m_scrollArea);

    // ËøûÊé•‰ø°Âè∑ÊßΩ
    connect(m_viewSubmissionsButton, &QPushButton::clicked, this, &AssignmentDetailWidget::onViewSubmissionsClicked);
}

void AssignmentDetailWidget::setupStyles()
{
    this->setStyleSheet(
        "#titleLabel {"
        "    font-size: 20px;"
        "    font-weight: bold;"
        "    color: #2c3e50;"
        "    padding: 10px 0px;"
        "    border-bottom: 3px solid #3498db;"
        "    margin-bottom: 10px;"
        "}"
        "#infoLabel {"
        "    font-size: 14px;"
        "    color: #7f8c8d;"
        "    padding: 8px 0px 15px 0px;"
        "    line-height: 1.5;"
        "}"
        "#sectionLabel {"
        "    font-size: 16px;"
        "    font-weight: bold;"
        "    color: #34495e;"
        "    margin-top: 15px;"
        "    margin-bottom: 8px;"
        "}"
        "#gradeLabel {"
        "    font-size: 14px;"
        "    color: #2c3e50;"
        "    padding: 12px;"
        "    background-color: #ecf0f1;"
        "    border-radius: 6px;"
        "    border-left: 4px solid #3498db;"
        "}"
        "#welcomeLabel {"
        "    font-size: 18px;"
        "    color: #95a5a6;"
        "    font-style: italic;"
        "}"
        "QTextEdit {"
        "    border: 1px solid #ddd;"
        "    border-radius: 6px;"
        "    background-color: #fafafa;"
        "    font-size: 14px;"
        "    padding: 8px;"
        "}"
        "QGroupBox {"
        "    font-weight: bold;"
        "    border: 2px solid #ddd;"
        "    border-radius: 8px;"
        "    margin-top: 10px;"
        "    padding-top: 15px;"
        "    background-color: #f8f9fa;"
        "}"
        "QProgressBar {"
        "    border: 1px solid #ddd;"
        "    border-radius: 4px;"
        "    text-align: center;"
        "    height: 20px;"
        "}"
        "QProgressBar::chunk {"
        "    background-color: #52c41a;"
        "    border-radius: 3px;"
        "}"
        );
}

void AssignmentDetailWidget::showAssignment(const QVariantMap &assignment, bool isTeacher)
{
    try {
        m_currentAssignment = assignment;
        m_isTeacherMode = isTeacher;

        m_welcomeWidget->hide();

        if (isTeacher) {
            showTeacherView(assignment);
        } else {
            showStudentView(assignment);
        }
    } catch (...) {
        qDebug() << "ÊòæÁ§∫‰Ωú‰∏öËØ¶ÊÉÖÊó∂ÂèëÁîüÂºÇÂ∏∏";
        clearContent();
    }
}

void AssignmentDetailWidget::showTeacherView(const QVariantMap &assignment)
{
    // ÊòæÁ§∫Âü∫Êú¨‰ø°ÊÅØ
    m_titleLabel->setText("üìã " + assignment["title"].toString());
    m_titleLabel->show();

    QString courseName = assignment["course_name"].toString();
    QDateTime deadline = assignment["deadline"].toDateTime();
    QString status = assignment["status"].toString();
    int maxScore = assignment["max_score"].toInt();

    QString infoText = QString("üìö ËØæÁ®ã: %1\n‚è∞ Êà™Ê≠¢Êó∂Èó¥: %2\nüìä Êª°ÂàÜ: %3ÂàÜ\nüìà Áä∂ÊÄÅ: %4")
                           .arg(courseName)
                           .arg(deadline.toString("yyyyÂπ¥MMÊúàddÊó• hh:mm"))
                           .arg(maxScore)
                           .arg(status);

    m_infoLabel->setText(infoText);
    m_infoLabel->show();

    // ÊòæÁ§∫‰Ωú‰∏öÊèèËø∞
    m_descriptionEdit->setPlainText(assignment["description"].toString());
    m_descriptionEdit->show();

    // ÈöêËóèÂ≠¶ÁîüÁõ∏ÂÖ≥ÁªÑ‰ª∂
    m_submissionGroup->hide();

    // ÊòæÁ§∫ÊïôÂ∏àÁªüËÆ°‰ø°ÊÅØ
    if (m_database) {
        try {
            int assignmentId = assignment["assignment_id"].toInt();
            QList<QVariantMap> submissions = m_database->getAssignmentSubmissions(assignmentId);

            int totalSubmissions = submissions.size();
            int gradedSubmissions = 0;

            for (const QVariantMap &submission : submissions) {
                if (submission["status"].toString() == "Â∑≤ÊâπÊîπ") {
                    gradedSubmissions++;
                }
            }

            m_submissionStatsLabel->setText(QString("üì§ Êèê‰∫§‰∫∫Êï∞: %1\n‚úÖ Â∑≤ÊâπÊîπ: %2\n‚è≥ ÂæÖÊâπÊîπ: %3")
                                                .arg(totalSubmissions)
                                                .arg(gradedSubmissions)
                                                .arg(totalSubmissions - gradedSubmissions));

            int progress = totalSubmissions > 0 ? (gradedSubmissions * 100 / totalSubmissions) : 0;
            m_gradeProgressBar->setValue(progress);
            m_gradeProgressBar->setFormat(QString("ÊâπÊîπËøõÂ∫¶: %1%").arg(progress));

            m_statsGroup->show();
        } catch (...) {
            qDebug() << "Âä†ËΩΩÊïôÂ∏àÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•";
            m_statsGroup->hide();
        }
    } else {
        m_statsGroup->hide();
    }
}

void AssignmentDetailWidget::showStudentView(const QVariantMap &assignment)
{
    // ÊòæÁ§∫Âü∫Êú¨‰ø°ÊÅØ
    m_titleLabel->setText("üìã " + assignment["title"].toString());
    m_titleLabel->show();

    QString courseName = assignment["course_name"].toString();
    QDateTime deadline = assignment["deadline"].toDateTime();
    QString status = assignment["status"].toString();
    int maxScore = assignment["max_score"].toInt();

    // ËÆ°ÁÆóÊó∂Èó¥Áä∂ÊÄÅ
    QString timeStatus;
    QDateTime now = QDateTime::currentDateTime();
    if (now > deadline) {
        timeStatus = "‚è∞ Â∑≤ËøáÊúü";
    } else {
        qint64 secsRemaining = now.secsTo(deadline);
        if (secsRemaining < 86400) {
            timeStatus = QString("‚ö†Ô∏è Ââ©‰Ωô %1 Â∞èÊó∂").arg(secsRemaining / 3600);
        } else {
            timeStatus = QString("‚è∞ Ââ©‰Ωô %1 Â§©").arg(secsRemaining / 86400);
        }
    }

    QString infoText = QString("üìö ËØæÁ®ã: %1\n%2\nüìä Êª°ÂàÜ: %3ÂàÜ\nüìà Áä∂ÊÄÅ: %4")
                           .arg(courseName)
                           .arg(timeStatus)
                           .arg(maxScore)
                           .arg(status);

    m_infoLabel->setText(infoText);
    m_infoLabel->show();

    // ÊòæÁ§∫‰Ωú‰∏öÊèèËø∞
    m_descriptionEdit->setPlainText(assignment["description"].toString());
    m_descriptionEdit->show();

    // ÈöêËóèÊïôÂ∏àÁõ∏ÂÖ≥ÁªÑ‰ª∂
    m_statsGroup->hide();

    // ÊòæÁ§∫Â≠¶ÁîüÊèê‰∫§‰ø°ÊÅØ
    if (assignment["has_submitted"].toBool()) {
        // ÊòæÁ§∫ÁúüÂÆûÁöÑÊèê‰∫§ÂÜÖÂÆπÔºàÁõ¥Êé•‰ªéassignmentÊï∞ÊçÆ‰∏≠Ëé∑ÂèñÔºâ
        QString submissionContent = assignment["submission_content"].toString();
        if (!submissionContent.isEmpty()) {
            m_submissionEdit->setPlainText(submissionContent);
        } else {
            m_submissionEdit->setPlainText("Êèê‰∫§ÂÜÖÂÆπ‰∏∫Á©∫");
        }
        m_submissionEdit->show();

        // ‰øÆÂ§çÊâπÊîπÁªìÊûúÊòæÁ§∫ÈóÆÈ¢ò
        if (assignment["submission_status"].toString() == "Â∑≤ÊâπÊîπ") {
            // ‰øÆÂ§çÊ†ºÂºèÂåñÂ≠óÁ¨¶‰∏≤ÈóÆÈ¢ò
            double score = assignment["score"].toDouble();
            QString feedback = assignment["feedback"].toString();

            QString gradeText = QString("üéØ ÂæóÂàÜ: %1/%2ÂàÜ\nüí¨ ÊïôÂ∏àËØÑËØ≠: %3")
                                    .arg(QString::number(score, 'f', 1))  // Ê≠£Á°ÆÁöÑÂàÜÊï∞
                                    .arg(maxScore)                        // Ê≠£Á°ÆÁöÑÊª°ÂàÜ
                                    .arg(feedback.isEmpty() ? "Êó†ËØÑËØ≠" : feedback);  // Ê≠£Á°ÆÁöÑËØÑËØ≠
            m_gradeLabel->setText(gradeText);
        } else {
            m_gradeLabel->setText("‚è≥ Á≠âÂæÖÊïôÂ∏àÊâπÊîπ‰∏≠...");
        }
        m_gradeLabel->show();
        m_submissionGroup->show();
    } else {
        m_submissionEdit->hide();
        m_gradeLabel->setText("‚ùå Â∞öÊú™Êèê‰∫§‰Ωú‰∏ö");
        m_gradeLabel->show();
        m_submissionGroup->show();
    }
}

void AssignmentDetailWidget::clearContent()
{
    m_titleLabel->hide();
    m_infoLabel->hide();
    m_descriptionEdit->hide();
    m_submissionGroup->hide();
    m_statsGroup->hide();
    m_welcomeWidget->show();
}

void AssignmentDetailWidget::onViewSubmissionsClicked()
{
    if (m_currentAssignment.isEmpty()) return;

    int assignmentId = m_currentAssignment["assignment_id"].toInt();

    // ÂàõÂª∫Âπ∂ÊòæÁ§∫ÊâπÊîπÂØπËØùÊ°Ü
    if (m_database) {
        GradeAssignmentDialog *dialog = new GradeAssignmentDialog(m_database, assignmentId, this);
        dialog->setAttribute(Qt::WA_DeleteOnClose);
        dialog->show();
    }
}

// ============================================================================
// GradeAssignmentDialog - ÊâπÊîπ‰Ωú‰∏öÂØπËØùÊ°ÜÂÆûÁé∞
// ============================================================================

GradeAssignmentDialog::GradeAssignmentDialog(Database *database, int assignmentId, QWidget *parent)
    : QDialog(parent), m_database(database), m_assignmentId(assignmentId), m_currentStudentId(-1)
{
    // Ëé∑Âèñ‰Ωú‰∏ö‰ø°ÊÅØ
    if (m_database) {
        m_assignmentTitle = m_database->getAssignmentTitle(assignmentId);
        m_maxScore = m_database->getAssignmentMaxScore(assignmentId);
    } else {
        m_assignmentTitle = "Êú™Áü•‰Ωú‰∏ö";
        m_maxScore = 100;
    }

    setupUI();
    setWindowTitle(QString("ÊâπÊîπ‰Ωú‰∏ö - %1").arg(m_assignmentTitle));
    setModal(false);
    resize(1000, 700);

    loadSubmissions();
}

void GradeAssignmentDialog::setupUI()
{
    QVBoxLayout *mainLayout = new QVBoxLayout(this);

    // È°∂ÈÉ®‰ø°ÊÅØ
    QLabel *titleLabel = new QLabel("üìä ‰Ωú‰∏öÊâπÊîπÁÆ°ÁêÜ");
    titleLabel->setStyleSheet("font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px;");
    mainLayout->addWidget(titleLabel);

    // ÂàõÂª∫ÂàÜÂâ≤Âô®
    m_splitter = new QSplitter(Qt::Horizontal);
    mainLayout->addWidget(m_splitter);

    // Â∑¶‰æßÔºöÂ≠¶ÁîüÂàóË°®
    QWidget *leftWidget = new QWidget();
    QVBoxLayout *leftLayout = new QVBoxLayout(leftWidget);

    QLabel *listLabel = new QLabel("üìã Êèê‰∫§ÂàóË°®");
    listLabel->setStyleSheet("font-weight: bold; margin-bottom: 5px;");
    leftLayout->addWidget(listLabel);

    m_studentTable = new QTableWidget();
    m_studentTable->setColumnCount(4);
    m_studentTable->setHorizontalHeaderLabels({"Â≠¶Áîü", "Êèê‰∫§Êó∂Èó¥", "Áä∂ÊÄÅ", "ÂæóÂàÜ"});
    m_studentTable->horizontalHeader()->setStretchLastSection(true);
    m_studentTable->setSelectionBehavior(QAbstractItemView::SelectRows);
    m_studentTable->setAlternatingRowColors(true);
    leftLayout->addWidget(m_studentTable);

    // ËøõÂ∫¶‰ø°ÊÅØ
    m_progressLabel = new QLabel("ÊâπÊîπËøõÂ∫¶: 0/0");
    m_progressBar = new QProgressBar();
    leftLayout->addWidget(m_progressLabel);
    leftLayout->addWidget(m_progressBar);

    // Êìç‰ΩúÊåâÈíÆ
    QHBoxLayout *buttonLayout = new QHBoxLayout();
    m_refreshButton = new QPushButton("üîÑ Âà∑Êñ∞");
    m_batchGradeButton = new QPushButton("üìä ÊâπÈáèËØÑÂàÜ");
    buttonLayout->addWidget(m_refreshButton);
    buttonLayout->addWidget(m_batchGradeButton);
    buttonLayout->addStretch();
    leftLayout->addLayout(buttonLayout);

    m_splitter->addWidget(leftWidget);

    // Âè≥‰æßÔºöÊâπÊîπÁïåÈù¢
    m_gradeGroup = new QGroupBox("üìù ÊâπÊîπËØ¶ÊÉÖ");
    QVBoxLayout *gradeLayout = new QVBoxLayout(m_gradeGroup);

    m_studentInfoLabel = new QLabel("ËØ∑ÈÄâÊã©Â≠¶ÁîüËøõË°åÊâπÊîπ");
    m_studentInfoLabel->setStyleSheet("font-weight: bold; color: #2c3e50;");
    gradeLayout->addWidget(m_studentInfoLabel);

    gradeLayout->addWidget(new QLabel("üìÑ Êèê‰∫§ÂÜÖÂÆπ:"));
    m_submissionContentEdit = new QTextEdit();
    m_submissionContentEdit->setReadOnly(true);
    m_submissionContentEdit->setMaximumHeight(200);
    gradeLayout->addWidget(m_submissionContentEdit);

    QHBoxLayout *scoreLayout = new QHBoxLayout();
    scoreLayout->addWidget(new QLabel("üìä ÂæóÂàÜ:"));
    m_scoreSpinBox = new QSpinBox();
    m_scoreSpinBox->setMinimum(0);
    m_scoreSpinBox->setMaximum(100);
    scoreLayout->addWidget(m_scoreSpinBox);
    scoreLayout->addWidget(new QLabel("ÂàÜ"));
    scoreLayout->addStretch();
    gradeLayout->addLayout(scoreLayout);

    gradeLayout->addWidget(new QLabel("üí¨ ËØÑËØ≠:"));
    m_feedbackEdit = new QTextEdit();
    m_feedbackEdit->setMaximumHeight(100);
    m_feedbackEdit->setPlaceholderText("ËØ∑ËæìÂÖ•ËØÑËØ≠...");
    gradeLayout->addWidget(m_feedbackEdit);

    m_submitGradeButton = new QPushButton("‚úÖ Êèê‰∫§ËØÑÂàÜ");
    m_submitGradeButton->setStyleSheet(
        "QPushButton {"
        "    background-color: #52c41a;"
        "    color: white;"
        "    font-weight: bold;"
        "    padding: 10px 20px;"
        "    border: none;"
        "    border-radius: 6px;"
        "}"
        "QPushButton:hover {"
        "    background-color: #389e0d;"
        "}"
        );
    gradeLayout->addWidget(m_submitGradeButton);

    m_splitter->addWidget(m_gradeGroup);

    // ËÆæÁΩÆÂàÜÂâ≤Âô®ÊØî‰æã
    m_splitter->setSizes({400, 600});

    // ËøûÊé•‰ø°Âè∑ÊßΩ
    connect(m_studentTable, &QTableWidget::itemSelectionChanged, this, &GradeAssignmentDialog::onStudentSelected);
    connect(m_submitGradeButton, &QPushButton::clicked, this, &GradeAssignmentDialog::onGradeSubmitted);
    connect(m_refreshButton, &QPushButton::clicked, this, &GradeAssignmentDialog::onRefreshSubmissions);
    connect(m_batchGradeButton, &QPushButton::clicked, this, &GradeAssignmentDialog::onBatchGrade);
}

void GradeAssignmentDialog::loadSubmissions()
{
    if (!m_database) return;

    try {
        m_submissions = m_database->getAssignmentSubmissions(m_assignmentId);

        m_studentTable->setRowCount(m_submissions.size());

        for (int i = 0; i < m_submissions.size(); ++i) {
            const QVariantMap &submission = m_submissions[i];

            QString studentName = submission["student_name"].toString();
            QDateTime submitTime = submission["submit_time"].toDateTime();
            QString status = submission["status"].toString();
            QString scoreText = submission["score"].isNull() ? "Êú™ËØÑÂàÜ" :
                                    QString::number(submission["score"].toDouble(), 'f', 1);

            m_studentTable->setItem(i, 0, new QTableWidgetItem(studentName));
            m_studentTable->setItem(i, 1, new QTableWidgetItem(submitTime.toString("MM-dd hh:mm")));
            m_studentTable->setItem(i, 2, new QTableWidgetItem(status));
            m_studentTable->setItem(i, 3, new QTableWidgetItem(scoreText));

            // Â≠òÂÇ®Â≠¶ÁîüID
            m_studentTable->item(i, 0)->setData(Qt::UserRole, submission["student_id"].toInt());

            // Ê†πÊçÆÁä∂ÊÄÅËÆæÁΩÆË°åÈ¢úËâ≤
            if (status == "Â∑≤ÊâπÊîπ") {
                for (int j = 0; j < 4; ++j) {
                    m_studentTable->item(i, j)->setBackground(QColor(240, 255, 240));
                }
            }
        }

        updateGradeProgress();

    } catch (...) {
        qDebug() << "Âä†ËΩΩÊèê‰∫§ÂàóË°®Â§±Ë¥•";
    }
}

void GradeAssignmentDialog::onStudentSelected()
{
    QList<QTableWidgetItem*> selectedItems = m_studentTable->selectedItems();
    if (selectedItems.isEmpty()) return;

    int row = selectedItems[0]->row();
    if (row < 0 || row >= m_submissions.size()) return;

    m_currentStudentId = m_studentTable->item(row, 0)->data(Qt::UserRole).toInt();
    loadStudentSubmission(m_currentStudentId);
}

void GradeAssignmentDialog::loadStudentSubmission(int studentId)
{
    if (!m_database) return;

    try {
        // ÊâæÂà∞ÂØπÂ∫îÁöÑÊèê‰∫§ËÆ∞ÂΩï
        QVariantMap submission;
        for (const QVariantMap &sub : m_submissions) {
            if (sub["student_id"].toInt() == studentId) {
                submission = sub;
                break;
            }
        }

        if (submission.isEmpty()) return;

        QString studentName = submission["student_name"].toString();
        QString grade = submission["grade"].toString();
        m_studentInfoLabel->setText(QString("üë§ Â≠¶Áîü: %1 (%2)").arg(studentName, grade));

        m_submissionContentEdit->setPlainText(submission["content"].toString());

        if (!submission["score"].isNull()) {
            m_scoreSpinBox->setValue(submission["score"].toInt());
        } else {
            m_scoreSpinBox->setValue(0);
        }

        m_feedbackEdit->setPlainText(submission["feedback"].toString());

        // Êõ¥Êñ∞Êª°ÂàÜËÆæÁΩÆ
        if (m_maxScore > 0) {
            m_scoreSpinBox->setMaximum(m_maxScore);
        }

    } catch (...) {
        qDebug() << "Âä†ËΩΩÂ≠¶ÁîüÊèê‰∫§ËØ¶ÊÉÖÂ§±Ë¥•";
    }
}

void GradeAssignmentDialog::onGradeSubmitted()
{
    if (m_currentStudentId <= 0) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ÂÖàÈÄâÊã©Â≠¶Áîü");
        return;
    }

    try {
        double score = m_scoreSpinBox->value();
        QString feedback = m_feedbackEdit->toPlainText().trimmed();

        if (m_database->gradeAssignment(m_assignmentId, m_currentStudentId, score, feedback)) {
            QMessageBox::information(this, "ÊàêÂäü", "ËØÑÂàÜÊèê‰∫§ÊàêÂäüÔºÅ");
            onRefreshSubmissions();
        } else {
            QMessageBox::warning(this, "Â§±Ë¥•", "ËØÑÂàÜÊèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï");
        }

    } catch (...) {
        qDebug() << "Êèê‰∫§ËØÑÂàÜÊó∂ÂèëÁîüÂºÇÂ∏∏";
        QMessageBox::critical(this, "ÈîôËØØ", "Êèê‰∫§ËØÑÂàÜÂ§±Ë¥•");
    }
}

void GradeAssignmentDialog::onBatchGrade()
{
    bool ok;
    double batchScore = QInputDialog::getDouble(this, "ÊâπÈáèËØÑÂàÜ",
                                                "ËØ∑ËæìÂÖ•Áªü‰∏ÄÂàÜÊï∞:", 85.0, 0.0, 100.0, 1, &ok);

    if (!ok) return;

    QString batchFeedback = QInputDialog::getText(this, "ÊâπÈáèËØÑÂàÜ",
                                                  "ËØ∑ËæìÂÖ•Áªü‰∏ÄËØÑËØ≠:", QLineEdit::Normal, "ÂÆåÊàêËâØÂ•Ω", &ok);

    if (!ok) return;

    QMessageBox::StandardButton reply = QMessageBox::question(
        this, "Á°ÆËÆ§ÊâπÈáèËØÑÂàÜ",
        QString("Á°ÆÂÆöË¶ÅÂ∞ÜÊâÄÊúâÊú™ËØÑÂàÜ‰Ωú‰∏öÈÉΩËØÑ‰∏∫ %.1f ÂàÜÂêóÔºü").arg(batchScore),
        QMessageBox::Yes | QMessageBox::No);

    if (reply != QMessageBox::Yes) return;

    try {
        int count = 0;
        for (const QVariantMap &submission : m_submissions) {
            if (submission["status"].toString() != "Â∑≤ÊâπÊîπ") {
                int studentId = submission["student_id"].toInt();
                if (m_database->gradeAssignment(m_assignmentId, studentId, batchScore, batchFeedback)) {
                    count++;
                }
            }
        }

        QMessageBox::information(this, "ÊâπÈáèËØÑÂàÜÂÆåÊàê", QString("ÊàêÂäüËØÑÂàÜ %1 ‰ªΩ‰Ωú‰∏ö").arg(count));
        onRefreshSubmissions();

    } catch (...) {
        qDebug() << "ÊâπÈáèËØÑÂàÜÊó∂ÂèëÁîüÂºÇÂ∏∏";
        QMessageBox::critical(this, "ÈîôËØØ", "ÊâπÈáèËØÑÂàÜÂ§±Ë¥•");
    }
}

void GradeAssignmentDialog::onRefreshSubmissions()
{
    loadSubmissions();
}

void GradeAssignmentDialog::updateGradeProgress()
{
    int total = m_submissions.size();
    int graded = 0;

    for (const QVariantMap &submission : m_submissions) {
        if (submission["status"].toString() == "Â∑≤ÊâπÊîπ") {
            graded++;
        }
    }

    m_progressLabel->setText(QString("ÊâπÊîπËøõÂ∫¶: %1/%2").arg(graded).arg(total));

    int progress = total > 0 ? (graded * 100 / total) : 0;
    m_progressBar->setValue(progress);
}

// ============================================================================
// PublishAssignmentDialog - ÂèëÂ∏É‰Ωú‰∏öÂØπËØùÊ°ÜÂÆûÁé∞Ôºà‰øùÊåÅÂéüÊúâÂäüËÉΩÔºâ
// ============================================================================

PublishAssignmentDialog::PublishAssignmentDialog(Database *database, int teacherId, QWidget *parent)
    : QDialog(parent)
    , m_database(database)
    , m_teacherId(teacherId)
{
    setupUI();
    setWindowTitle("ÂèëÂ∏ÉËØæÁ®ã‰Ωú‰∏ö");
    setModal(true);
    resize(500, 400);
}

void PublishAssignmentDialog::setupUI()
{
    QVBoxLayout *mainLayout = new QVBoxLayout(this);

    // Âü∫Êú¨‰ø°ÊÅØ
    QGroupBox *basicGroup = new QGroupBox("Âü∫Êú¨‰ø°ÊÅØ");
    QFormLayout *basicLayout = new QFormLayout(basicGroup);

    m_courseCombo = new QComboBox();
    QList<Course> courses = m_database->getTeacherCourses(m_teacherId);
    for (const Course &course : courses) {
        m_courseCombo->addItem(course.getCourseName(), course.getCourseId());
    }

    m_titleLineEdit = new QLineEdit();
    m_titleLineEdit->setPlaceholderText("ËØ∑ËæìÂÖ•‰Ωú‰∏öÊ†áÈ¢ò...");

    m_deadlineEdit = new QDateTimeEdit();
    m_deadlineEdit->setDateTime(QDateTime::currentDateTime().addDays(7)); // ÈªòËÆ§‰∏ÄÂë®Âêé
    m_deadlineEdit->setMinimumDateTime(QDateTime::currentDateTime());

    m_maxScoreEdit = new QLineEdit("100");

    basicLayout->addRow("ÈÄâÊã©ËØæÁ®ã:", m_courseCombo);
    basicLayout->addRow("‰Ωú‰∏öÊ†áÈ¢ò:", m_titleLineEdit);
    basicLayout->addRow("Êà™Ê≠¢Êó∂Èó¥:", m_deadlineEdit);
    basicLayout->addRow("Êª°ÂàÜ:", m_maxScoreEdit);

    mainLayout->addWidget(basicGroup);

    // ‰Ωú‰∏öÊèèËø∞
    QGroupBox *contentGroup = new QGroupBox("‰Ωú‰∏öÊèèËø∞");
    QVBoxLayout *contentLayout = new QVBoxLayout(contentGroup);

    m_descriptionEdit = new QTextEdit();
    m_descriptionEdit->setPlaceholderText("ËØ∑ËæìÂÖ•‰Ωú‰∏öË¶ÅÊ±ÇÂíåÊèèËø∞...");
    m_descriptionEdit->setMinimumHeight(150);

    contentLayout->addWidget(m_descriptionEdit);
    mainLayout->addWidget(contentGroup);

    // Êìç‰ΩúÊåâÈíÆ
    QHBoxLayout *buttonLayout = new QHBoxLayout();
    QPushButton *publishButton = new QPushButton("üìù ÂèëÂ∏É‰Ωú‰∏ö");
    QPushButton *cancelButton = new QPushButton("‚ùå ÂèñÊ∂à");

    publishButton->setStyleSheet(
        "QPushButton {"
        "    background-color: #52c41a;"
        "    color: white;"
        "    font-weight: bold;"
        "    padding: 10px 20px;"
        "    border: none;"
        "    border-radius: 6px;"
        "}"
        "QPushButton:hover {"
        "    background-color: #389e0d;"
        "}"
        );

    buttonLayout->addStretch();
    buttonLayout->addWidget(cancelButton);
    buttonLayout->addWidget(publishButton);

    mainLayout->addLayout(buttonLayout);

    // ËøûÊé•‰ø°Âè∑ÊßΩ
    connect(publishButton, &QPushButton::clicked, this, &PublishAssignmentDialog::onPublishClicked);
    connect(cancelButton, &QPushButton::clicked, this, &PublishAssignmentDialog::onCancelClicked);
}

void PublishAssignmentDialog::onPublishClicked()
{
    if (!validateInput()) {
        return;
    }

    int courseId = m_courseCombo->currentData().toInt();
    QString title = m_titleLineEdit->text().trimmed();
    QString description = m_descriptionEdit->toPlainText().trimmed();
    QDateTime deadline = m_deadlineEdit->dateTime();
    int maxScore = m_maxScoreEdit->text().toInt();

    int assignmentId = m_database->publishAssignment(courseId, title, description, deadline, maxScore);

    if (assignmentId > 0) {
        QMessageBox::information(this, "ÊàêÂäü", "‰Ωú‰∏öÂèëÂ∏ÉÊàêÂäüÔºÅ");
        accept();
    } else {
        QMessageBox::warning(this, "Â§±Ë¥•", "‰Ωú‰∏öÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
    }
}

void PublishAssignmentDialog::onCancelClicked()
{
    reject();
}

bool PublishAssignmentDialog::validateInput()
{
    if (m_courseCombo->currentData().toInt() <= 0) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ÈÄâÊã©ËØæÁ®ã");
        return false;
    }

    if (m_titleLineEdit->text().trimmed().isEmpty()) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ËæìÂÖ•‰Ωú‰∏öÊ†áÈ¢ò");
        m_titleLineEdit->setFocus();
        return false;
    }

    if (m_descriptionEdit->toPlainText().trimmed().isEmpty()) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ËæìÂÖ•‰Ωú‰∏öÊèèËø∞");
        m_descriptionEdit->setFocus();
        return false;
    }

    if (m_deadlineEdit->dateTime() <= QDateTime::currentDateTime()) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "Êà™Ê≠¢Êó∂Èó¥ÂøÖÈ°ªÊôö‰∫éÂΩìÂâçÊó∂Èó¥");
        m_deadlineEdit->setFocus();
        return false;
    }

    bool ok;
    int maxScore = m_maxScoreEdit->text().toInt(&ok);
    if (!ok || maxScore <= 0) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊª°ÂàÜÊï∞ÂÄº");
        m_maxScoreEdit->setFocus();
        return false;
    }

    return true;
}

// ============================================================================
// SubmitAssignmentDialog - Êèê‰∫§‰Ωú‰∏öÂØπËØùÊ°ÜÂÆûÁé∞Ôºà‰øùÊåÅÂéüÊúâÂäüËÉΩÔºâ
// ============================================================================

SubmitAssignmentDialog::SubmitAssignmentDialog(int assignmentId, const QString &assignmentTitle,
                                               Database *database, int studentId, QWidget *parent)
    : QDialog(parent)
    , m_assignmentId(assignmentId)
    , m_database(database)
    , m_studentId(studentId)
    , m_assignmentTitle(assignmentTitle)
{
    setupUI();
    setWindowTitle("Êèê‰∫§‰Ωú‰∏ö");
    setModal(true);
    resize(500, 400);
}

void SubmitAssignmentDialog::setupUI()
{
    QVBoxLayout *mainLayout = new QVBoxLayout(this);

    // ‰Ωú‰∏ö‰ø°ÊÅØ
    QLabel *titleLabel = new QLabel(QString("üìã ‰Ωú‰∏ö: %1").arg(m_assignmentTitle));
    titleLabel->setStyleSheet("font-size: 16px; font-weight: bold; color: #2c3e50; margin-bottom: 10px;");
    mainLayout->addWidget(titleLabel);

    // Êèê‰∫§ÂÜÖÂÆπ
    QGroupBox *contentGroup = new QGroupBox("üìù Êèê‰∫§ÂÜÖÂÆπ");
    QVBoxLayout *contentLayout = new QVBoxLayout(contentGroup);

    m_contentEdit = new QTextEdit();
    m_contentEdit->setPlaceholderText("ËØ∑Âú®Ê≠§ËæìÂÖ•‰Ωú‰∏öÂÜÖÂÆπ...");
    m_contentEdit->setMinimumHeight(250);

    contentLayout->addWidget(m_contentEdit);
    mainLayout->addWidget(contentGroup);

    // ÊèêÁ§∫‰ø°ÊÅØ
    QLabel *tipLabel = new QLabel("üí° ÊèêÁ§∫: Êèê‰∫§ÂêéÊó†Ê≥ï‰øÆÊîπÔºåËØ∑Á°ÆËÆ§ÂÜÖÂÆπÊó†ËØØÂêéÂÜçÊèê‰∫§");
    tipLabel->setStyleSheet("color: #fa8c16; font-size: 12px; margin: 10px 0;");
    mainLayout->addWidget(tipLabel);

    // Êìç‰ΩúÊåâÈíÆ
    QHBoxLayout *buttonLayout = new QHBoxLayout();
    QPushButton *submitButton = new QPushButton("üì§ Êèê‰∫§‰Ωú‰∏ö");
    QPushButton *cancelButton = new QPushButton("‚ùå ÂèñÊ∂à");

    submitButton->setStyleSheet(
        "QPushButton {"
        "    background-color: #1890ff;"
        "    color: white;"
        "    font-weight: bold;"
        "    padding: 10px 20px;"
        "    border: none;"
        "    border-radius: 6px;"
        "}"
        "QPushButton:hover {"
        "    background-color: #096dd9;"
        "}"
        );

    buttonLayout->addStretch();
    buttonLayout->addWidget(cancelButton);
    buttonLayout->addWidget(submitButton);

    mainLayout->addLayout(buttonLayout);

    // ËøûÊé•‰ø°Âè∑ÊßΩ
    connect(submitButton, &QPushButton::clicked, this, &SubmitAssignmentDialog::onSubmitClicked);
    connect(cancelButton, &QPushButton::clicked, this, &SubmitAssignmentDialog::onCancelClicked);
}

void SubmitAssignmentDialog::onSubmitClicked()
{
    if (!validateInput()) {
        return;
    }

    QMessageBox::StandardButton reply = QMessageBox::question(
        this, "Á°ÆËÆ§Êèê‰∫§",
        "Á°ÆÂÆöË¶ÅÊèê‰∫§Ëøô‰ªΩ‰Ωú‰∏öÂêóÔºüÊèê‰∫§ÂêéÊó†Ê≥ï‰øÆÊîπ„ÄÇ",
        QMessageBox::Yes | QMessageBox::No);

    if (reply != QMessageBox::Yes) {
        return;
    }

    QString content = m_contentEdit->toPlainText().trimmed();

    if (m_database->submitAssignment(m_assignmentId, m_studentId, content)) {
        QMessageBox::information(this, "ÊàêÂäü", "‰Ωú‰∏öÊèê‰∫§ÊàêÂäüÔºÅ");
        accept();
    } else {
        QMessageBox::warning(this, "Â§±Ë¥•", "‰Ωú‰∏öÊèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï");
    }
}

void SubmitAssignmentDialog::onCancelClicked()
{
    reject();
}

bool SubmitAssignmentDialog::validateInput()
{
    if (m_contentEdit->toPlainText().trimmed().isEmpty()) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ËæìÂÖ•‰Ωú‰∏öÂÜÖÂÆπ");
        m_contentEdit->setFocus();
        return false;
    }

    return true;
}
