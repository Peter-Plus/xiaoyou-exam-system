#include "groupdetailwidget.h"
#include <QDebug>

GroupDetailWidget::GroupDetailWidget(Database *database, int userId,
                                     const QString &userType, QWidget *parent)
    : QWidget(parent)
    , m_database(database)
    , m_userId(userId)
    , m_userType(userType)
    , m_currentGroupId(-1)
    , m_isCreator(false)
{
    setupUI();
    setupStyles();
    showEmptyState();
}

void GroupDetailWidget::setupUI()
{
    m_mainLayout = new QVBoxLayout(this);
    m_mainLayout->setContentsMargins(0, 0, 0, 0);

    // ÊªöÂä®Âå∫Âüü
    m_scrollArea = new QScrollArea();
    m_scrollArea->setWidgetResizable(true);
    m_scrollArea->setObjectName("groupDetailScrollArea");

    m_contentWidget = new QWidget();
    m_contentLayout = new QVBoxLayout(m_contentWidget);
    m_contentLayout->setContentsMargins(16, 16, 16, 16);
    m_contentLayout->setSpacing(16);

    // Áæ§ËÅäÂü∫Êú¨‰ø°ÊÅØ
    m_basicInfoBox = new QGroupBox("üìã Áæ§ËÅä‰ø°ÊÅØ");
    QVBoxLayout *basicLayout = new QVBoxLayout(m_basicInfoBox);
    basicLayout->setSpacing(8);

    m_groupNameLabel = new QLabel();
    m_groupNameLabel->setObjectName("groupNameLabel");
    m_creatorLabel = new QLabel();
    m_creatorLabel->setObjectName("groupInfoLabel");
    m_memberCountLabel = new QLabel();
    m_memberCountLabel->setObjectName("groupInfoLabel");
    m_createTimeLabel = new QLabel();
    m_createTimeLabel->setObjectName("groupInfoLabel");

    basicLayout->addWidget(m_groupNameLabel);
    basicLayout->addWidget(m_creatorLabel);
    basicLayout->addWidget(m_memberCountLabel);
    basicLayout->addWidget(m_createTimeLabel);

    // ÊàêÂëòÂàóË°®
    m_membersBox = new QGroupBox("üë• Áæ§ËÅäÊàêÂëò");
    QVBoxLayout *membersLayout = new QVBoxLayout(m_membersBox);

    m_memberList = new QListWidget();
    m_memberList->setObjectName("groupMemberList");
    m_memberList->setMaximumHeight(200);
    membersLayout->addWidget(m_memberList);

    // Êìç‰ΩúÊåâÈíÆ
    m_operationsBox = new QGroupBox("‚öôÔ∏è Áæ§ËÅäÊìç‰Ωú");
    m_buttonLayout = new QHBoxLayout(m_operationsBox);

    m_inviteButton = new QPushButton("‚ûï ÈÇÄËØ∑ÊàêÂëò");
    m_inviteButton->setObjectName("inviteButton");
    m_disbandButton = new QPushButton("üí• Ëß£Êï£Áæ§ËÅä");
    m_disbandButton->setObjectName("disbandButton");
    m_leaveButton = new QPushButton("üö™ ÈÄÄÂá∫Áæ§ËÅä");
    m_leaveButton->setObjectName("leaveButton");

    m_buttonLayout->addWidget(m_inviteButton);
    m_buttonLayout->addWidget(m_disbandButton);
    m_buttonLayout->addWidget(m_leaveButton);
    m_buttonLayout->addStretch();

    // Á©∫Áä∂ÊÄÅÊ†áÁ≠æ
    m_emptyLabel = new QLabel("ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Áæ§ËÅäÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ");
    m_emptyLabel->setAlignment(Qt::AlignCenter);
    m_emptyLabel->setObjectName("emptyStateLabel");

    // ÁªÑË£ÖÂ∏ÉÂ±Ä
    m_contentLayout->addWidget(m_basicInfoBox);
    m_contentLayout->addWidget(m_membersBox);
    m_contentLayout->addWidget(m_operationsBox);
    m_contentLayout->addWidget(m_emptyLabel);
    m_contentLayout->addStretch();

    m_scrollArea->setWidget(m_contentWidget);
    m_mainLayout->addWidget(m_scrollArea);

    // ËøûÊé•‰ø°Âè∑
    connect(m_inviteButton, &QPushButton::clicked,
            this, &GroupDetailWidget::onInviteMember);
    connect(m_disbandButton, &QPushButton::clicked,
            this, &GroupDetailWidget::onDisbandGroup);
    connect(m_leaveButton, &QPushButton::clicked,
            this, &GroupDetailWidget::onLeaveGroup);
}

void GroupDetailWidget::setupStyles()
{
    QString styles = R"(
        QWidget {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        #groupDetailScrollArea {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        QGroupBox {
            font-weight: bold;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-top: 8px;
            padding-top: 8px;
            background-color: white;
        }

        QGroupBox::title {
            subcontrol-origin: margin;
            left: 10px;
            padding: 0 8px 0 8px;
            color: #495057;
        }

        #groupNameLabel {
            font-size: 18px;
            font-weight: bold;
            color: #212529;
            padding: 4px;
        }

        #groupInfoLabel {
            font-size: 14px;
            color: #6c757d;
            padding: 2px 4px;
        }

        #groupMemberList {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        #groupMemberList::item {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        #groupMemberList::item:hover {
            background-color: #e9ecef;
        }

        #inviteButton {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: bold;
        }

        #inviteButton:hover {
            background-color: #218838;
        }

        #disbandButton {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: bold;
        }

        #disbandButton:hover {
            background-color: #c82333;
        }

        #leaveButton {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: bold;
        }

        #leaveButton:hover {
            background-color: #5a6268;
        }

        #emptyStateLabel {
            font-size: 16px;
            color: #6c757d;
            padding: 40px;
        }
    )";

    setStyleSheet(styles);
}

void GroupDetailWidget::showGroupDetail(int groupId, bool isCreator)
{
    qDebug() << "ÊòæÁ§∫Áæ§ËÅäËØ¶ÊÉÖ:" << groupId << "ÊòØÂê¶ÂàõÂª∫ËÄÖ:" << isCreator;

    m_currentGroupId = groupId;
    m_isCreator = isCreator;

    // ÈöêËóèÁ©∫Áä∂ÊÄÅÔºåÊòæÁ§∫ËØ¶ÊÉÖ
    m_emptyLabel->hide();
    m_basicInfoBox->show();
    m_membersBox->show();
    m_operationsBox->show();

    // Âä†ËΩΩÁæ§ËÅä‰ø°ÊÅØ
    QVariantMap groupInfo = m_database->getGroupInfo(groupId);
    if (groupInfo.isEmpty()) {
        qWarning() << "Êó†Ê≥ïËé∑ÂèñÁæ§ËÅä‰ø°ÊÅØ:" << groupId;
        clearDetail();
        return;
    }

    // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
    m_groupNameLabel->setText(QString("Áæ§ËÅäÂêçÁß∞Ôºö%1").arg(groupInfo["group_name"].toString()));
    m_creatorLabel->setText(QString("ÂàõÂª∫ËÄÖÔºö%1 %2")
                                .arg(groupInfo["creator_name"].toString())
                                .arg(groupInfo["creator_type"].toString()));
    m_memberCountLabel->setText(QString("ÊàêÂëòÊï∞ÈáèÔºö%1‰∫∫").arg(groupInfo["member_count"].toInt()));
    m_createTimeLabel->setText(QString("ÂàõÂª∫Êó∂Èó¥Ôºö%1")
                                   .arg(groupInfo["created_time"].toDateTime().toString("yyyy-MM-dd hh:mm")));

    // Âä†ËΩΩÊàêÂëòÂàóË°®
    loadGroupMembers();

    // Êõ¥Êñ∞Êìç‰ΩúÊåâÈíÆ
    updateOperationButtons(isCreator);
}

void GroupDetailWidget::clearDetail()
{
    m_currentGroupId = -1;
    m_isCreator = false;

    showEmptyState();
}

void GroupDetailWidget::showEmptyState()
{
    m_basicInfoBox->hide();
    m_membersBox->hide();
    m_operationsBox->hide();
    m_emptyLabel->show();
}

void GroupDetailWidget::loadGroupMembers()
{
    m_memberList->clear();

    if (m_currentGroupId <= 0) return;

    QList<QVariantMap> members = m_database->getGroupMembers(m_currentGroupId);

    for (const QVariantMap &member : members) {
        QString memberText;
        QString role = member["role"].toString();

        if (role == "ÂàõÂª∫ËÄÖ") {
            memberText = QString("üëë %1 %2 (%3)")
                             .arg(member["user_name"].toString())
                             .arg(member["user_type"].toString())
                             .arg(role);
        } else {
            memberText = QString("üë§ %1 %2 (%3)")
                             .arg(member["user_name"].toString())
                             .arg(member["user_type"].toString())
                             .arg(role);
        }

        // Ê∑ªÂä†Â≠¶Èô¢‰ø°ÊÅØ
        if (member.contains("user_college") && !member["user_college"].toString().isEmpty()) {
            memberText += QString(" - %1").arg(member["user_college"].toString());
        }

        QListWidgetItem *item = new QListWidgetItem(memberText);
        m_memberList->addItem(item);
    }

    qDebug() << "Âä†ËΩΩÁæ§ËÅäÊàêÂëòÂÆåÊàêÔºåÂÖ±" << members.size() << "‰∫∫";
}

void GroupDetailWidget::updateOperationButtons(bool isCreator)
{
    if (isCreator) {
        // ÂàõÂª∫ËÄÖÔºöÊòæÁ§∫ÈÇÄËØ∑ÊàêÂëòÂíåËß£Êï£Áæ§ËÅä
        m_inviteButton->show();
        m_disbandButton->show();
        m_leaveButton->hide();
    } else {
        // ÊôÆÈÄöÊàêÂëòÔºöÂè™ÊòæÁ§∫ÈÄÄÂá∫Áæ§ËÅä
        m_inviteButton->hide();
        m_disbandButton->hide();
        m_leaveButton->show();
    }
}

void GroupDetailWidget::onInviteMember()
{
    if (m_currentGroupId <= 0) return;

    qDebug() << "ÊâìÂºÄÈÇÄËØ∑ÊàêÂëòÂØπËØùÊ°ÜÔºåÁæ§ËÅäID:" << m_currentGroupId;

    // ÂàõÂª∫ÈÇÄËØ∑ÊàêÂëòÂØπËØùÊ°Ü
    InviteMemberDialog dialog(m_database, m_currentGroupId,
                              m_groupNameLabel->text().remove("Áæ§ËÅäÂêçÁß∞Ôºö"),
                              m_userId, m_userType, this);

    if (dialog.exec() == QDialog::Accepted) {
        // ÈÇÄËØ∑ÊàêÂäüÔºåÂà∑Êñ∞Áæ§ËÅä‰ø°ÊÅØ
        refreshGroupInfo();
        emit memberInvited(m_currentGroupId);
    }
}

void GroupDetailWidget::onDisbandGroup()
{
    if (m_currentGroupId <= 0) {
        QMessageBox::warning(this, "ÈîôËØØ", "Êú™ÈÄâÊã©Áæ§ËÅä");
        return;
    }

    // Ëé∑ÂèñÁæ§ËÅäÂêçÁß∞Áî®‰∫éÁ°ÆËÆ§
    QString groupName = m_groupNameLabel->text().remove("Áæ§ËÅäÂêçÁß∞Ôºö");

    QMessageBox::StandardButton reply = QMessageBox::question(
        this, "Á°ÆËÆ§Ëß£Êï£",
        QString("Á°ÆÂÆöË¶ÅËß£Êï£Áæ§ËÅä„Äå%1„ÄçÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞ÜÔºö\n‚Ä¢ ÁßªÈô§ÊâÄÊúâÁæ§ËÅäÊàêÂëò\n‚Ä¢ Âà†Èô§ÊâÄÊúâÁæ§ËÅäÊ∂àÊÅØ\n‚Ä¢ Âà†Èô§Áæ§ËÅäËÆ∞ÂΩï\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ").arg(groupName),
        QMessageBox::Yes | QMessageBox::No,
        QMessageBox::No);  // ÈªòËÆ§ÈÄâÊã©No

    if (reply == QMessageBox::Yes) {
        qDebug() << "Áî®Êà∑Á°ÆËÆ§Ëß£Êï£Áæ§ËÅä:" << m_currentGroupId;

        bool success = m_database->disbandGroup(m_currentGroupId, m_userId, m_userType);
        if (success) {
            QMessageBox::information(this, "Êìç‰ΩúÊàêÂäü", "Áæ§ËÅäÂ∑≤Ëß£Êï£");
            emit groupDisbanded(m_currentGroupId);
            clearDetail();
        } else {
            // Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
            QString errorMsg = "Ëß£Êï£Áæ§ËÅäÂ§±Ë¥•ÔºåÂèØËÉΩÂéüÂõ†Ôºö\n";
            errorMsg += "‚Ä¢ ÊÇ®‰∏çÊòØÁæ§ËÅäÂàõÂª∫ËÄÖ\n";
            errorMsg += "‚Ä¢ Êï∞ÊçÆÂ∫ìËøûÊé•ÂºÇÂ∏∏\n";
            errorMsg += "‚Ä¢ Áæ§ËÅä‰∏çÂ≠òÂú®\n\n";
            errorMsg += "ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï";

            QMessageBox::critical(this, "Êìç‰ΩúÂ§±Ë¥•", errorMsg);
        }
    }
}

void GroupDetailWidget::onLeaveGroup()
{
    if (m_currentGroupId <= 0) {
        QMessageBox::warning(this, "ÈîôËØØ", "Êú™ÈÄâÊã©Áæ§ËÅä");
        return;
    }

    // Ëé∑ÂèñÁæ§ËÅäÂêçÁß∞Áî®‰∫éÁ°ÆËÆ§
    QString groupName = m_groupNameLabel->text().remove("Áæ§ËÅäÂêçÁß∞Ôºö");

    QMessageBox::StandardButton reply = QMessageBox::question(
        this, "Á°ÆËÆ§ÈÄÄÂá∫",
        QString("Á°ÆÂÆöË¶ÅÈÄÄÂá∫Áæ§ËÅä„Äå%1„ÄçÂêóÔºü\n\nÈÄÄÂá∫ÂêéÊÇ®Â∞ÜÊó†Ê≥ïÊé•Êî∂Áæ§ËÅäÊ∂àÊÅØÔºåÈúÄË¶ÅÈáçÊñ∞Áî≥ËØ∑Âä†ÂÖ•„ÄÇ").arg(groupName),
        QMessageBox::Yes | QMessageBox::No);

    if (reply == QMessageBox::Yes) {
        qDebug() << "Áî®Êà∑Á°ÆËÆ§ÈÄÄÂá∫Áæ§ËÅä:" << m_currentGroupId;

        bool success = m_database->leaveGroup(m_currentGroupId, m_userId, m_userType);
        if (success) {
            QMessageBox::information(this, "Êìç‰ΩúÊàêÂäü", "Â∑≤ÈÄÄÂá∫Áæ§ËÅä");
            emit groupLeft(m_currentGroupId);
            clearDetail();
        } else {
            // Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
            QString errorMsg = "ÈÄÄÂá∫Áæ§ËÅäÂ§±Ë¥•ÔºåÂèØËÉΩÂéüÂõ†Ôºö\n";
            errorMsg += "‚Ä¢ ÊÇ®ÊòØÁæ§ËÅäÂàõÂª∫ËÄÖÔºàÂàõÂª∫ËÄÖ‰∏çËÉΩÈÄÄÂá∫ÔºåÂè™ËÉΩËß£Êï£Ôºâ\n";
            errorMsg += "‚Ä¢ ÊÇ®‰∏çÊòØÁæ§ËÅäÊàêÂëò\n";
            errorMsg += "‚Ä¢ Êï∞ÊçÆÂ∫ìËøûÊé•ÂºÇÂ∏∏\n";
            errorMsg += "‚Ä¢ Áæ§ËÅä‰∏çÂ≠òÂú®\n\n";
            errorMsg += "ËØ∑Ê£ÄÊü•ÂêéÈáçËØï";

            QMessageBox::critical(this, "Êìç‰ΩúÂ§±Ë¥•", errorMsg);
        }
    }
}

void GroupDetailWidget::refreshGroupInfo()
{
    if (m_currentGroupId > 0) {
        showGroupDetail(m_currentGroupId, m_isCreator);
    }
}
